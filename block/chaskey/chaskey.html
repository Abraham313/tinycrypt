<h3><strong>Introduction</strong></h3>

<p><a href="http://mouha.be/chaskey/">Chaskey</a> is a 12 round 128-bit block cipher with support for 128-bit keys. It's used as the underlying function for the <a href="https://tinycrypt.wordpress.com/2017/01/10/asmcodes-chaskey/">Chaskey Message Authentication Code</a> (MAC). It uses an Even-Mansour construction that makes it very simple to implement. Because the permutation function is derived from SipHash and uses only ARX instructions, that makes it highly suitable for many architectures. <strong><a href="http://www.wisdom.weizmann.ac.il/~oded/s_even.html">Shimon Even</a></strong> and <strong><a href="https://www.tau.ac.il/~mansour/">Yishay Mansour</a></strong> published a paper in 1997 titled <em>A Construction of a Cipher From a Single Pseudorandom Permutation</em> which suggested an incredibly simple but provably secure design for a cryptographic algorithm.</p>

<img src="https://tinycrypt.files.wordpress.com/2017/02/even_mansour.jpg" alt="even_mansour" width="640" height="206" class="aligncenter size-full wp-image-1819" />

<p>Key Whitening, a technique invented by <a href="https://people.csail.mit.edu/rivest/">Ron Rivest</a> in 1984 is performed before and after the application of <em>F</em> which is a publicly known permutation function. Key Whitening consists of using a simple XOR operation of the key with data which is intended to increase resistance to brute force attack and is used in many modern ciphers today.</p>

<h3><strong>F function</strong></h3>

<p>The permutation function uses 16 rounds of ADD/ROL/XOR (ARX) instructions for encryption and is derived from the <a href="https://131002.net/siphash/">SipHash</a> algorithm. SipHash is a fast short-input <em>Pseudo-Random-Function</em>(PRF) designed and published in 2012 by <a href="https://131002.net/">Jean-Philippe Aumasson</a> and <a href="http://cr.yp.to/djb.html">Daniel J. Bernstein</a>. The decryption of ciphertext is simply reversing the permutation function using SUB/ROR/XOR.</p>

<img src="https://tinycrypt.files.wordpress.com/2017/02/perm.png" alt="perm" width="441" height="501" class="aligncenter size-full wp-image-1820" />

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>void</span> chas_encrypt<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>int</span> enc<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>key<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>buf<span style='color:#808030;'>)</span> 
<span style='color:#800080;'>{</span>
   <span style='color:#800000;font-weight:bold;'>int</span>      i<span style='color:#800080;'>;</span>
   uint32_t <span style='color:#808030;'>*</span>v<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>buf<span style='color:#800080;'>;</span>
   uint32_t <span style='color:#808030;'>*</span>k<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>key<span style='color:#800080;'>;</span>
   
   <span style='color:#696969;'>// pre-whiten</span>
   <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>4</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
     v<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
   <span style='color:#800080;'>}</span>

   <span style='color:#696969;'>// apply permutation function</span>
   <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>16</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
     <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>enc<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span>CHASKEY_ENCRYPT<span style='color:#808030;'>)</span>
     <span style='color:#800080;'>{</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>       
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span><span style='color:#008c00;'>13</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> 
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
     <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800080;'>{</span>     
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTR32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTR32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>-</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTR32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span><span style='color:#008c00;'>13</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>-</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTR32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>-</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTR32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTR32<span style='color:#808030;'>(</span>v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
       v<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>-</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
     <span style='color:#800080;'>}</span>
   <span style='color:#800080;'>}</span>
   <span style='color:#696969;'>// post-whiten</span>
   <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>4</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
     v<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
   <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

The assembly is straight forward. We load buffer into ESI, key into EDI and enc into ECX. Load 4 32-bit registers with 128-bit data, apply pre-whitening with 128-bit key. Test ECX for zero, then save flag status with PUSHFD. This then frees ECX to use as a loop counter which is set to 16 (for LTS). 

After each round of permutation, restore the flag status with POPFD and keep looping until ECX is zero. Finally apply post-whitening using 128-bit key, save and return.

<pre style='color:#000000;background:#ffffff;'><span style='color:#004a43;'>%define</span><span style='color:#004a43;'> v0 eax</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> v1 ebx</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> v2 edx</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> v3 ebp</span>

<span style='color:#e34adc;'>chas_encryptx:</span>
<span style='color:#e34adc;'>_chas_encryptx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>     <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>          <span style='color:#696969;'>; ecx = enc</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>          <span style='color:#696969;'>; edi = key</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esi</span>          <span style='color:#696969;'>; esi = buf</span>
    <span style='color:#800000;font-weight:bold;'>push</span>    <span style='color:#000080;'>esi</span>
    <span style='color:#696969;'>; load buf</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v1
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v3
    <span style='color:#696969;'>; pre-whiten</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v0<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span>   <span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v2<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>12</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>test</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>     <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
<span style='color:#e34adc;'>ck_l0:</span>
    <span style='color:#800000;font-weight:bold;'>pushfd</span>
    <span style='color:#800000;font-weight:bold;'>jz</span>      <span style='color:#e34adc;'>ck_l1</span>
    <span style='color:#696969;'>; encrypt</span>
    <span style='color:#800000;font-weight:bold;'>add</span>     v0<span style='color:#808030;'>,</span> v1
    <span style='color:#800000;font-weight:bold;'>rol</span>     v1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>5</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> v0
    <span style='color:#800000;font-weight:bold;'>rol</span>     v0<span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>add</span>     v2<span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>rol</span>     v3<span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>add</span>     v0<span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>rol</span>     v3<span style='color:#808030;'>,</span> <span style='color:#008c00;'>13</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> v0
    <span style='color:#800000;font-weight:bold;'>add</span>     v2<span style='color:#808030;'>,</span> v1
    <span style='color:#800000;font-weight:bold;'>rol</span>     v1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>rol</span>     v2<span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>jmp</span>     <span style='color:#e34adc;'>ck_l2</span>
<span style='color:#e34adc;'>ck_l1:</span>
    <span style='color:#696969;'>; decrypt</span>
    <span style='color:#800000;font-weight:bold;'>ror</span>     v2<span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>ror</span>     v1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>     v2<span style='color:#808030;'>,</span> v1
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> v0
    <span style='color:#800000;font-weight:bold;'>ror</span>     v3<span style='color:#808030;'>,</span> <span style='color:#008c00;'>13</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>     v0<span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>ror</span>     v3<span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>     v2<span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>ror</span>     v0<span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> v0
    <span style='color:#800000;font-weight:bold;'>ror</span>     v1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>5</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>     v0<span style='color:#808030;'>,</span> v1
<span style='color:#e34adc;'>ck_l2:</span>
    <span style='color:#800000;font-weight:bold;'>popfd</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>    <span style='color:#e34adc;'>ck_l0</span>
<span style='color:#e34adc;'>ck_l3:</span>
    <span style='color:#696969;'>; post-whiten</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v0<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span>   <span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v2<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>12</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>     <span style='color:#000080;'>edi</span>
    <span style='color:#696969;'>; save buf</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v1
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<h3><strong>Encryption in one call</strong></h3>

To use with CTR mode as a stream cipher.

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; -----------------------------------------------</span>
<span style='color:#696969;'>; Chaskey-LTS block cipher in x86 assembly (encryption only)</span>
<span style='color:#696969;'>;</span>
<span style='color:#696969;'>; size: 89 bytes</span>
<span style='color:#696969;'>;</span>
<span style='color:#696969;'>; global calls use cdecl convention</span>
<span style='color:#696969;'>;</span>
<span style='color:#696969;'>; -----------------------------------------------</span>

    <span style='color:#004a43;'>bits</span> <span style='color:#008c00;'>32</span>

<span style='color:#004a43;'>%ifndef</span><span style='color:#004a43;'> BIN</span>
  <span style='color:#004a43;'>global</span> chas_encryptx
  <span style='color:#004a43;'>global</span> _chas_encryptx
<span style='color:#004a43;'>%endif</span>

<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> v0 eax</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> v1 ebx</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> v2 edx</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> v3 ebp</span>

<span style='color:#e34adc;'>chas_encryptx:</span>
<span style='color:#e34adc;'>_chas_encryptx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>     <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>     <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+12</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>push</span>    <span style='color:#000080;'>esi</span>
    <span style='color:#696969;'>; load buf</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v1
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v3
    <span style='color:#696969;'>; pre-whiten</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v0<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span>   <span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v2<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>12</span><span style='color:#808030;'>]</span>
    <span style='color:#696969;'>; 16 rounds</span>
    <span style='color:#800000;font-weight:bold;'>push</span>    <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>     <span style='color:#000080;'>ecx</span>
<span style='color:#e34adc;'>ck_l0:</span>    
    <span style='color:#696969;'>; apply permutation</span>
    <span style='color:#800000;font-weight:bold;'>add</span>     v0<span style='color:#808030;'>,</span> v1
    <span style='color:#800000;font-weight:bold;'>rol</span>     v1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>5</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> v0
    <span style='color:#800000;font-weight:bold;'>rol</span>     v0<span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>add</span>     v2<span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>rol</span>     v3<span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>add</span>     v0<span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>rol</span>     v3<span style='color:#808030;'>,</span> <span style='color:#008c00;'>13</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> v0
    <span style='color:#800000;font-weight:bold;'>add</span>     v2<span style='color:#808030;'>,</span> v1
    <span style='color:#800000;font-weight:bold;'>rol</span>     v1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>rol</span>     v2<span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>    <span style='color:#e34adc;'>ck_l0</span>
    <span style='color:#696969;'>; post-whiten</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v0<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span>   <span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v1<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v2<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>     v3<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>12</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>     <span style='color:#000080;'>edi</span>
    <span style='color:#696969;'>; save buf</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v1
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v2
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> v3
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

A version for ARMv6

<pre style='color:#000000;background:#ffffff;'>k  .req r0
x  .req r1

k0 .req r2
k1 .req r3
k2 .req r4
k3 .req r5

x0 .req r6
x1 .req r7
x2 .req r8
x3 .req r9

i  .req r1<span style='color:#008c00;'>0</span>
  
  <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> chas_encryptx<span style='color:#808030;'>(</span>void <span style='color:#808030;'>*</span>key<span style='color:#808030;'>,</span> void <span style='color:#808030;'>*</span><span style='color:#004a43;'>data</span><span style='color:#808030;'>)</span><span style='color:#696969;'>;</span>
<span style='color:#e34adc;'>chas_encryptx:</span>
  
  <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> saxe registers
  <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#808030;'>{</span>r0<span style='color:#808030;'>-</span>r1<span style='color:#008c00;'>2</span><span style='color:#808030;'>,</span>lr<span style='color:#808030;'>}</span>
  
  <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> load <span style='color:#008c00;'>128</span><span style='color:#808030;'>-</span>bit key
  ldm    k<span style='color:#808030;'>,</span> <span style='color:#808030;'>{</span>k0<span style='color:#808030;'>,</span> k1<span style='color:#808030;'>,</span> k2<span style='color:#808030;'>,</span> k3<span style='color:#808030;'>}</span>
  
  <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> load <span style='color:#008c00;'>128</span><span style='color:#808030;'>-</span>bit plaintext
  ldm    x<span style='color:#808030;'>,</span> <span style='color:#808030;'>{</span>x0<span style='color:#808030;'>,</span> x1<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>}</span>
  
  <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> <span style='color:#800000;font-weight:bold;'>xor</span> plaintext <span style='color:#004a43;'>with</span> key
  eor    x0<span style='color:#808030;'>,</span> x0<span style='color:#808030;'>,</span> k0          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x1<span style='color:#808030;'>,</span> x1<span style='color:#808030;'>,</span> k1          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x2<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> k2          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x3<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>,</span> k3          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  <span style='color:#800000;font-weight:bold;'>mov</span>    i<span style='color:#808030;'>,</span> #<span style='color:#008c00;'>16</span>              <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> i <span style='color:#808030;'>=</span> <span style='color:#008c00;'>16</span>
<span style='color:#e34adc;'>chaskey_loop:</span>
  <span style='color:#800000;font-weight:bold;'>add</span>    x0<span style='color:#808030;'>,</span> x0<span style='color:#808030;'>,</span> x1          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x1<span style='color:#808030;'>,</span> x0<span style='color:#808030;'>,</span> x1<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>ror</span> #<span style='color:#008c00;'>27</span> <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL3<span style='color:#008c00;'>2</span><span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>5</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  <span style='color:#800000;font-weight:bold;'>add</span>    x2<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> x3          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x3<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>ror</span> #<span style='color:#008c00;'>24</span> <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL3<span style='color:#008c00;'>2</span><span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>8</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  <span style='color:#800000;font-weight:bold;'>add</span>    x2<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> x1          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  <span style='color:#800000;font-weight:bold;'>add</span>    x0<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>,</span> x0<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>ror</span> #<span style='color:#008c00;'>16</span> <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL3<span style='color:#008c00;'>2</span><span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x3<span style='color:#808030;'>,</span> x0<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>ror</span> #<span style='color:#008c00;'>19</span> <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL3<span style='color:#008c00;'>2</span><span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x1<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> x1<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>ror</span> #<span style='color:#008c00;'>25</span> <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL3<span style='color:#008c00;'>2</span><span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>7</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  <span style='color:#800000;font-weight:bold;'>mov</span>    x2<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>ror</span> #<span style='color:#008c00;'>16</span>     <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>ROTL3<span style='color:#008c00;'>2</span><span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span><span style='color:#696969;'>;</span>
  subs   i<span style='color:#808030;'>,</span> i<span style='color:#808030;'>,</span> #<span style='color:#008c00;'>1</span>            <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> i<span style='color:#808030;'>-</span><span style='color:#808030;'>-</span>
  bne    chaskey_loop        <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> i<span style='color:#808030;'>&gt;</span><span style='color:#008c00;'>0</span>
  
  <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> <span style='color:#800000;font-weight:bold;'>xor</span> ciphertext <span style='color:#004a43;'>with</span> key
  eor    x0<span style='color:#808030;'>,</span> x0<span style='color:#808030;'>,</span> k0          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x1<span style='color:#808030;'>,</span> x1<span style='color:#808030;'>,</span> k1          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x2<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> k2          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  eor    x3<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>,</span> k3          <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> k<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#696969;'>;</span>
  
  <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> save ciphertext
  stm    x<span style='color:#808030;'>,</span> <span style='color:#808030;'>{</span>x0<span style='color:#808030;'>,</span> x1<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>}</span>
  
  <span style='color:#808030;'>/</span><span style='color:#808030;'>/</span> restore registers
  <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#808030;'>{</span>r0<span style='color:#808030;'>-</span>r1<span style='color:#008c00;'>2</span><span style='color:#808030;'>,</span>pc<span style='color:#808030;'>}</span>
</pre>

<h3><strong>Summary</strong></h3>

C code is approx. 185 bytes using /O2 /Os flags. Assembly is currently 132 bytes. 

See <a href="https://github.com/odzhan/tinycrypt/tree/master/block/chaskey">sources here</a>
