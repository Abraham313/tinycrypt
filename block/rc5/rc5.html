<a href="https://people.csail.mit.edu/rivest/Rivest-rc5rev.pdf">RC5</a> is a symmetric block cipher designed in 1994 by <a href="https://people.csail.mit.edu/rivest/">Ronald Rivest</a>.

It uses 128-bit keys, processes 64-bit blocks of data using 12 rounds of encryption/decryption.

<strong>Key setup</strong>

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>void</span> rc5_setkey <span style='color:#808030;'>(</span>RC5_CTX <span style='color:#808030;'>*</span>key<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>input<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>  
  uint32_t i<span style='color:#808030;'>,</span> j<span style='color:#808030;'>,</span> k<span style='color:#808030;'>,</span> A<span style='color:#808030;'>,</span> B<span style='color:#808030;'>,</span> T<span style='color:#808030;'>,</span> L<span style='color:#808030;'>[</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>*</span>kptr<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>input<span style='color:#800080;'>;</span> 
  
  <span style='color:#696969;'>// initialize L with key</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>4</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    L<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> kptr<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
  
  A<span style='color:#808030;'>=</span>RC5_P<span style='color:#800080;'>;</span>
  
  <span style='color:#696969;'>// initialize S with constants</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span>RC5_KR<span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> 
    key<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>S<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> A<span style='color:#800080;'>;</span>
    A <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> RC5_Q<span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
  
  A<span style='color:#808030;'>=</span>B<span style='color:#808030;'>=</span>i<span style='color:#808030;'>=</span>j<span style='color:#808030;'>=</span>k<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>
  
  <span style='color:#696969;'>// mix with key</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span><span style='color:#800080;'>;</span> k <span style='color:#808030;'>&lt;</span> RC5_KR<span style='color:#808030;'>*</span><span style='color:#008c00;'>3</span><span style='color:#800080;'>;</span> k<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> 
    A <span style='color:#808030;'>=</span> key<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>S<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> ROTL<span style='color:#808030;'>(</span>key<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>S<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span> A<span style='color:#808030;'>+</span>B<span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>  
    B <span style='color:#808030;'>=</span> L<span style='color:#808030;'>[</span>j<span style='color:#808030;'>]</span>      <span style='color:#808030;'>=</span> ROTL<span style='color:#808030;'>(</span>L<span style='color:#808030;'>[</span>j<span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span> A<span style='color:#808030;'>+</span>B<span style='color:#808030;'>,</span> A<span style='color:#808030;'>+</span>B<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    
    i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#800080;'>;</span>
    i <span style='color:#808030;'>%</span><span style='color:#808030;'>=</span> RC5_KR<span style='color:#800080;'>;</span>
    
    j<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#800080;'>;</span>
    j <span style='color:#808030;'>%</span><span style='color:#808030;'>=</span> RC5_KEYLEN<span style='color:#808030;'>/</span><span style='color:#008c00;'>4</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span> 
<span style='color:#800080;'>}</span>
</pre>

This function was originally optimized by <a href="http://pferrie.host22.com/">Peter Ferrie.</a>

<pre style='color:#000000;background:#ffffff;'><span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_ENCRYPT 1</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_DECRYPT 0</span>

<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_BLK_LEN 8</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_ROUNDS  12</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_KEYLEN  16</span>

<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_KR      (2*(RC5_ROUNDS+1))</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_P       0xB7E15163</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_Q       0x9E3779B9</span>

<span style='color:#e34adc;'>_rc5_setkeyx:</span>
<span style='color:#e34adc;'>rc5_setkey:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; rc5 ctx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; key</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>

    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esi</span>
    
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> RC5_P
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> RC5_KR
<span style='color:#e34adc;'>sk_l1:</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> RC5_Q
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>sk_l1</span>
    
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebp</span>    <span style='color:#696969;'>; j=0</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>    <span style='color:#696969;'>; A=0</span>
    <span style='color:#800000;font-weight:bold;'>cdq</span>                <span style='color:#696969;'>; B=0</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ch</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>-</span>RC5_KR<span style='color:#808030;'>*</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>)</span> &amp; <span style='color:#008c00;'>255</span>

<span style='color:#e34adc;'>sk_l2:</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>    <span style='color:#696969;'>; i=0</span>
<span style='color:#e34adc;'>sk_l3:</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> RC5_KR
    <span style='color:#800000;font-weight:bold;'>je</span>     <span style='color:#e34adc;'>sk_l2</span>
    
    <span style='color:#696969;'>; A = key-&gt;x[i] = ROTL32(key-&gt;x[i] + A+B, 3); </span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#696969;'>; B = L[j] = ROTL32(L[j] + A+B, A+B);</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>dl</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    <span style='color:#696969;'>; i++</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edi</span> 
    <span style='color:#696969;'>; j++</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>ebp</span>       
    <span style='color:#696969;'>; j %= RC5_KEYLEN/4</span>
    <span style='color:#800000;font-weight:bold;'>and</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span>
<span style='color:#e34adc;'>sk_l4:</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>ch</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>sk_l3</span>
      
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<strong>Encryption</strong>

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>void</span> rc5_crypt <span style='color:#808030;'>(</span>RC5_CTX <span style='color:#808030;'>*</span>key<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span><span style='color:#808030;'>*</span> input<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span><span style='color:#808030;'>*</span> output<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>int</span> enc<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
  rc5_blk <span style='color:#808030;'>*</span>in<span style='color:#808030;'>,</span> <span style='color:#808030;'>*</span>out<span style='color:#800080;'>;</span>
  uint32_t <span style='color:#808030;'>*</span>k<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>key<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>x<span style='color:#800080;'>;</span>
  uint32_t A<span style='color:#808030;'>,</span> B<span style='color:#808030;'>,</span> T<span style='color:#808030;'>,</span> i<span style='color:#800080;'>;</span>
  
  in<span style='color:#808030;'>=</span>input<span style='color:#800080;'>;</span>
  out<span style='color:#808030;'>=</span>output<span style='color:#800080;'>;</span>
  
  A<span style='color:#808030;'>=</span>in<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  B<span style='color:#808030;'>=</span>in<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  
  <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>enc<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span>RC5_ENCRYPT<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    A <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>*</span>k<span style='color:#800080;'>;</span> k<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#800080;'>;</span>
    B <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>*</span>k<span style='color:#800080;'>;</span> k<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800080;'>{</span>
    k <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> RC5_KR <span style='color:#808030;'>-</span> <span style='color:#008c00;'>1</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
  
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span>RC5_KR<span style='color:#808030;'>-</span><span style='color:#008c00;'>2</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span>
  <span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>enc<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span>RC5_ENCRYPT<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      A <span style='color:#808030;'>=</span> ROTL32<span style='color:#808030;'>(</span>A <span style='color:#808030;'>^</span> B<span style='color:#808030;'>,</span> B<span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> <span style='color:#808030;'>*</span>k<span style='color:#800080;'>;</span> k<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800080;'>{</span>
      B <span style='color:#808030;'>=</span> ROTR32<span style='color:#808030;'>(</span>B <span style='color:#808030;'>-</span> <span style='color:#808030;'>*</span>k<span style='color:#808030;'>,</span> A<span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> A<span style='color:#800080;'>;</span> k<span style='color:#808030;'>-</span><span style='color:#808030;'>-</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    <span style='color:#696969;'>// swap</span>
    T <span style='color:#808030;'>=</span> B<span style='color:#800080;'>;</span>
    B <span style='color:#808030;'>=</span> A<span style='color:#800080;'>;</span>
    A <span style='color:#808030;'>=</span> T<span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
  <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>enc<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span>RC5_DECRYPT<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    B <span style='color:#808030;'>-</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>*</span>k<span style='color:#800080;'>;</span> k<span style='color:#808030;'>-</span><span style='color:#808030;'>-</span><span style='color:#800080;'>;</span>
    A <span style='color:#808030;'>-</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>*</span>k<span style='color:#800080;'>;</span> k<span style='color:#808030;'>-</span><span style='color:#808030;'>-</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
  out<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>A<span style='color:#800080;'>;</span>
  out<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>B<span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>
</pre>

<pre style='color:#000000;background:#ffffff;'><span style='color:#004a43;'>%define</span><span style='color:#004a43;'> A ebx</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> B ebp</span>
 
<span style='color:#e34adc;'>_rc5_cryptx:</span>
<span style='color:#e34adc;'>rc5_crypt:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>   
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>               <span style='color:#696969;'>; save rc5 ctx</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>               <span style='color:#696969;'>; save input</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>                    <span style='color:#696969;'>; </span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>          <span style='color:#696969;'>; output</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>cdq</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>          <span style='color:#696969;'>; enc</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>esi</span>               <span style='color:#696969;'>; esi=input</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>                    <span style='color:#696969;'>; eax = A</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> A
    <span style='color:#800000;font-weight:bold;'>lodsd</span>                    <span style='color:#696969;'>; eax = B</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> B
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>esi</span>               <span style='color:#696969;'>; esi=rc5 ctx</span>
    <span style='color:#696969;'>; -------------          ; </span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> RC5_KR<span style='color:#808030;'>-</span><span style='color:#008c00;'>2</span>
    <span style='color:#800000;font-weight:bold;'>jecxz</span>  <span style='color:#e34adc;'>r5_l0</span>             <span style='color:#696969;'>; do decryption</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    A<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    B<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>jmp</span>    <span style='color:#e34adc;'>r5_l2</span>
<span style='color:#e34adc;'>r5_l0:</span>
    <span style='color:#800000;font-weight:bold;'>std</span>                      <span style='color:#696969;'>; move backwards</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>  <span style='color:#696969;'>; advance key to end</span>
<span style='color:#e34adc;'>r5_l2:</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#696969;'>; if ecx==0 do decryption</span>
    <span style='color:#800000;font-weight:bold;'>jecxz</span> <span style='color:#e34adc;'>r5_l3</span>
    <span style='color:#696969;'>; A = ROTL(A^B,B) + key-&gt;x[i+2];</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>   A<span style='color:#808030;'>,</span> B
    <span style='color:#800000;font-weight:bold;'>mov</span>   <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> B
    <span style='color:#800000;font-weight:bold;'>rol</span>   A<span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>
    <span style='color:#800000;font-weight:bold;'>add</span>   A<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>jmp</span>   <span style='color:#e34adc;'>r5_l4</span>
<span style='color:#e34adc;'>r5_l3:</span>
    <span style='color:#696969;'>; B = ROTR(B - key-&gt;x[i+1], A) ^ A;</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>   B<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>   <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> A
    <span style='color:#800000;font-weight:bold;'>ror</span>   B<span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>   B<span style='color:#808030;'>,</span> A
<span style='color:#e34adc;'>r5_l4:</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>  A<span style='color:#808030;'>,</span> B
    <span style='color:#800000;font-weight:bold;'>dec</span>   <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>   <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>   <span style='color:#e34adc;'>r5_l2</span>
    <span style='color:#696969;'>; -----------</span>
    <span style='color:#800000;font-weight:bold;'>dec</span>   <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>jz</span>    <span style='color:#e34adc;'>r5_l5</span>
    <span style='color:#696969;'>; -----------</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>   B<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>   A<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
<span style='color:#e34adc;'>r5_l5:</span>
    <span style='color:#800000;font-weight:bold;'>cld</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>  <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> A
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>  <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> B
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<h3>Encryption in single call</h3>

We can encrypt 64-bits using a 128-bit key in one call. Currently 120 bytes.

<pre style='color:#000000;background:#ffffff;'><span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_ROUNDS  12    </span><span style='color:#696969;'>; 20 to strengthen against weakness</span>

<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> RC5_KR      (2*(RC5_ROUNDS+1))</span>

<span style='color:#696969;'>; rc5_cryptx(void *key, void *data) </span>
<span style='color:#e34adc;'>_xrc5_cryptx:</span>
<span style='color:#e34adc;'>xrc5_cryptx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>     <span style='color:#696969;'>; edi = key / L</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>]</span>     <span style='color:#696969;'>; esi = data</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>            <span style='color:#696969;'>; ecx = 0</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> RC5_KR<span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#008c00;'>+16</span>     <span style='color:#696969;'>; allocate space for key and sub keys</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>            <span style='color:#696969;'>; esp = S</span>
    <span style='color:#696969;'>; copy 128-bit key to local buffer</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>            <span style='color:#696969;'>; edi = L</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>
    <span style='color:#696969;'>; initialize S / sub keys </span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edi</span>                 <span style='color:#696969;'>; save S</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB7E15163</span>     <span style='color:#696969;'>; eax = RC6_P</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> RC5_KR    
<span style='color:#e34adc;'>init_subkeys:</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>                      <span style='color:#696969;'>; S[i] = A</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9E3779B9</span>     <span style='color:#696969;'>; A += RC6_Q</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>init_subkeys</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>                 <span style='color:#696969;'>; restore S</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>            <span style='color:#696969;'>; esi = data</span>
    <span style='color:#800000;font-weight:bold;'>mul</span>    <span style='color:#000080;'>ecx</span>                 <span style='color:#696969;'>; eax = 0, edx = 0</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>            <span style='color:#696969;'>; ebx = 0</span>
<span style='color:#e34adc;'>set_idx:</span>    
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebp</span>            <span style='color:#696969;'>; i % RC6_KR    </span>
<span style='color:#e34adc;'>init_key_loop:</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> RC5_KR
    <span style='color:#800000;font-weight:bold;'>je</span>     <span style='color:#e34adc;'>set_idx</span>    

    <span style='color:#696969;'>; A = S[i%RC6_KR] = ROTL32(S[i%RC5_KR] + A+B, 3); </span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>            <span style='color:#696969;'>; A += B</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>    <span style='color:#696969;'>; A += S[i%RC5_KR]</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span>              <span style='color:#696969;'>; A  = ROTL32(A, 3)</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>    <span style='color:#696969;'>; S[i%RC6_KR] = A</span>
    
    <span style='color:#696969;'>; B = L[i%4] = ROTL32(L[i%4] + A+B, A+B);</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>            <span style='color:#696969;'>; B += A</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>            <span style='color:#696969;'>; save A+B in ecx</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edx</span>                 <span style='color:#696969;'>; save i</span>
    <span style='color:#800000;font-weight:bold;'>and</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span>               <span style='color:#696969;'>; %= 4</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#008c00;'>-16</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; B += L[i%4]    </span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>             <span style='color:#696969;'>; B = ROTL32(B, A+B)</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#008c00;'>-16</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span> <span style='color:#696969;'>; L[i%4] = B    </span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edx</span>                 <span style='color:#696969;'>; restore i    </span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>ebp</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>                 <span style='color:#696969;'>; i++</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> RC5_KR<span style='color:#808030;'>*</span><span style='color:#008c00;'>3</span>        <span style='color:#696969;'>; i&lt;RC6_KR*3</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>init_key_loop</span>    
    
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>esi</span>                 <span style='color:#696969;'>; save ptr to data    </span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>                      <span style='color:#696969;'>; eax = x-&gt;w[0]</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span>          <span style='color:#696969;'>; A  += *k; k++;</span>
    <span style='color:#800000;font-weight:bold;'>scasd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>            <span style='color:#696969;'>; XCHG(A, B);</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>                      <span style='color:#696969;'>; eax = x-&gt;w[1]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> RC5_KR <span style='color:#808030;'>-</span> <span style='color:#008c00;'>1</span>   
    <span style='color:#800000;font-weight:bold;'>jmp</span>    <span style='color:#e34adc;'>mix_key</span>
<span style='color:#e34adc;'>enc_loop:</span>
    <span style='color:#696969;'>; A = ROTL32(A ^ B, B) + *k*; k++;</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>             <span style='color:#696969;'>; A ^= B </span>
    <span style='color:#800000;font-weight:bold;'>mov</span>   <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>             <span style='color:#696969;'>; ecx = B </span>
    <span style='color:#800000;font-weight:bold;'>rol</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>              <span style='color:#696969;'>; A = ROTL32(A ^ B, B)</span>
<span style='color:#e34adc;'>mix_key:</span>     
    <span style='color:#800000;font-weight:bold;'>add</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span>           <span style='color:#696969;'>; A += *k; k++;</span>
    <span style='color:#800000;font-weight:bold;'>scasd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>  <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>             <span style='color:#696969;'>; XCHG(A, B);</span>
    <span style='color:#800000;font-weight:bold;'>dec</span>   <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>   <span style='color:#e34adc;'>enc_loop</span>    
    
    <span style='color:#800000;font-weight:bold;'>pop</span>   <span style='color:#000080;'>esp</span>                  <span style='color:#696969;'>; restore ptr to data    </span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>  <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>                      <span style='color:#696969;'>; x-&gt;w[0] = A</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>  <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>                      <span style='color:#696969;'>; x-&gt;w[1] = B         </span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<strong>Results</strong>

See <a href="https://github.com/odzhan/tinycrypt/tree/master/block/rc5">sources here</a>

<table>
<tbody>
<tr>
<th>architecture</th>
<th>size</th>
</tr>
<tr>
<td>x86</td>
<td>167</td>
</tr>
<tr>
<td>x64</td>
<td>190</td>
</tr>
</tbody>
</table>
