<h3>Introduction</h3>

<a href="http://csrc.nist.gov/publications/fips/fips180-4/fips-180-4.pdf">SHA-2 </a>(Secure Hash Algorithm) consists of 6 cryptographic hash functions designed by the NSA which were published in 2001 under royalty free patent. They are intended to be used for data integrity, message authentication and digital signatures.

To avoid confusion, what follows is a tiny implementation in x86 assembler, optimized for size, so if you require a version optimized for speed, consider using a library such as <a href="https://tls.mbed.org/">PolarSSL</a> or <a href="https://www.openssl.org/">OpenSSL</a>

<h2>Init, Update, Final</h2>

Normally, the initialization, update and finalization processes are separate functions so data can be processed sequentially. To compact it as much as possible, the function presented here can only be called once and the input length should not exceed ~500MB.

The limitation is due to len variable defined as a 32-bit integer rather than 64-bit which it should be.
The following structure for holding state is used.

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>typedef</span> <span style='color:#800000;font-weight:bold;'>struct</span> _SHA256_CTX <span style='color:#800080;'>{</span>
  uint64_t len<span style='color:#800080;'>;</span>
  <span style='color:#800000;font-weight:bold;'>union</span> <span style='color:#800080;'>{</span>
    uint8_t  v8<span style='color:#808030;'>[</span>SHA256_DIGEST_LENGTH<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    uint32_t v32<span style='color:#808030;'>[</span>SHA256_DIGEST_LENGTH<span style='color:#808030;'>/</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    uint64_t v64<span style='color:#808030;'>[</span>SHA256_DIGEST_LENGTH<span style='color:#808030;'>/</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span> s<span style='color:#800080;'>;</span>
  <span style='color:#800000;font-weight:bold;'>union</span> <span style='color:#800080;'>{</span>
    uint8_t  v8<span style='color:#808030;'>[</span>SHA256_CBLOCK<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    uint32_t v32<span style='color:#808030;'>[</span>SHA256_CBLOCK<span style='color:#808030;'>/</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    uint64_t v64<span style='color:#808030;'>[</span>SHA256_CBLOCK<span style='color:#808030;'>/</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span> buf<span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span> SHA256_CTX<span style='color:#800080;'>;</span>
</pre>

The function that includes init, update and final functions in one call.

<pre style='color:#000000;background:#ffffff;'>uint16_t p<span style='color:#808030;'>[</span><span style='color:#008c00;'>64</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span>
<span style='color:#800080;'>{</span>  <span style='color:#008c00;'>2</span><span style='color:#808030;'>,</span>   <span style='color:#008c00;'>3</span><span style='color:#808030;'>,</span>   <span style='color:#008c00;'>5</span><span style='color:#808030;'>,</span>   <span style='color:#008c00;'>7</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>11</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>13</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>17</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>19</span><span style='color:#808030;'>,</span> 
  <span style='color:#008c00;'>23</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>29</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>31</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>37</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>41</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>43</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>47</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>53</span><span style='color:#808030;'>,</span>
  <span style='color:#008c00;'>59</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>61</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>67</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>71</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>73</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>79</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>83</span><span style='color:#808030;'>,</span>  <span style='color:#008c00;'>89</span><span style='color:#808030;'>,</span> 
  <span style='color:#008c00;'>97</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>101</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>103</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>107</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>109</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>113</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>127</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>131</span><span style='color:#808030;'>,</span>
 <span style='color:#008c00;'>137</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>139</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>149</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>151</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>157</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>163</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>167</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>173</span><span style='color:#808030;'>,</span> 
 <span style='color:#008c00;'>179</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>181</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>191</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>193</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>197</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>199</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>211</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>223</span><span style='color:#808030;'>,</span>
 <span style='color:#008c00;'>227</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>229</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>233</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>239</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>241</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>251</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>257</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>263</span><span style='color:#808030;'>,</span> 
 <span style='color:#008c00;'>269</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>271</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>277</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>281</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>283</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>293</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>307</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>311</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>

<span style='color:#696969;'>// cube root of integer</span>
<span style='color:#696969;'>// return fractional part as integer</span>
uint32_t cbr2int <span style='color:#808030;'>(</span>uint32_t x<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
  uint32_t r<span style='color:#800080;'>;</span>
  r <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>)</span><span style='color:#808030;'>(</span><span style='color:#603000;'>fabs</span><span style='color:#808030;'>(</span><span style='color:#603000;'>pow</span><span style='color:#808030;'>(</span><span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>double</span><span style='color:#808030;'>)</span>p<span style='color:#808030;'>[</span>x<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span><span style='color:#008000;'>1.0</span><span style='color:#808030;'>/</span><span style='color:#008000;'>3.0</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#808030;'>*</span><span style='color:#603000;'>pow</span><span style='color:#808030;'>(</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>,</span><span style='color:#008c00;'>32</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
  <span style='color:#800000;font-weight:bold;'>return</span> r<span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>

<span style='color:#800000;font-weight:bold;'>void</span> SHA256_Transform <span style='color:#808030;'>(</span>SHA256X_CTX <span style='color:#808030;'>*</span>ctx<span style='color:#808030;'>)</span> 
<span style='color:#800080;'>{</span>
  uint32_t t1<span style='color:#808030;'>,</span> t2<span style='color:#808030;'>,</span> i<span style='color:#808030;'>,</span> j<span style='color:#808030;'>,</span> t<span style='color:#800080;'>;</span>
  uint32_t w<span style='color:#808030;'>[</span><span style='color:#008c00;'>64</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> s<span style='color:#808030;'>[</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  
  <span style='color:#696969;'>// load data in big endian format</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>16</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span>ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>buffer<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>

  <span style='color:#696969;'>// expand data into 512-bit buffer</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>16</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>64</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> SIG1<span style='color:#808030;'>(</span>w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>-</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>-</span><span style='color:#008c00;'>7</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span> SIG0<span style='color:#808030;'>(</span>w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>-</span><span style='color:#008c00;'>15</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>-</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
  
  <span style='color:#696969;'>// load state into local buffer</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    s<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
  
  <span style='color:#696969;'>// for 64 rounds</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>64</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span>
  <span style='color:#800080;'>{</span>
    t1 <span style='color:#808030;'>=</span> s<span style='color:#808030;'>[</span><span style='color:#008c00;'>7</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span> EP1<span style='color:#808030;'>(</span>s<span style='color:#808030;'>[</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> CH<span style='color:#808030;'>(</span>s<span style='color:#808030;'>[</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> s<span style='color:#808030;'>[</span><span style='color:#008c00;'>5</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> s<span style='color:#808030;'>[</span><span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    t1 <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> cbr2int<span style='color:#808030;'>(</span>i<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    t2 <span style='color:#808030;'>=</span> EP0<span style='color:#808030;'>(</span>s<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> MAJ<span style='color:#808030;'>(</span>s<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> s<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> s<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    s<span style='color:#808030;'>[</span><span style='color:#008c00;'>7</span><span style='color:#808030;'>]</span>  <span style='color:#808030;'>=</span> t1 <span style='color:#808030;'>+</span> t2<span style='color:#800080;'>;</span>
    s<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> t1<span style='color:#800080;'>;</span>
    <span style='color:#696969;'>// rotate "right" 32-bits</span>
    t1<span style='color:#808030;'>=</span>s<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> <span style='color:#696969;'>// load a</span>
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>j<span style='color:#808030;'>=</span><span style='color:#008c00;'>1</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      t2<span style='color:#808030;'>=</span>s<span style='color:#808030;'>[</span>j<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
      s<span style='color:#808030;'>[</span>j<span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>t1<span style='color:#800080;'>;</span>
      t1<span style='color:#808030;'>=</span>t2<span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    s<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>t1<span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
  
  <span style='color:#696969;'>// save state</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> s<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>

uint32_t h<span style='color:#808030;'>[</span>SHA256_LBLOCK<span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>
<span style='color:#800080;'>{</span> <span style='color:#008000;'>0x6a09e667</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xbb67ae85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3c6ef372</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa54ff53a</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x510e527f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9b05688c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1f83d9ab</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5be0cd19</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>

<span style='color:#800000;font-weight:bold;'>void</span> SHA256 <span style='color:#808030;'>(</span>uint32_t inlen<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>in<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>out<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
  SHA256X_CTX ctx<span style='color:#800080;'>;</span>
  uint32_t i<span style='color:#808030;'>,</span> idx<span style='color:#800080;'>;</span>
  uint8_t <span style='color:#808030;'>*</span>p<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint8_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>in<span style='color:#800080;'>;</span>
  
  <span style='color:#696969;'>// initialize context</span>
  ctx<span style='color:#808030;'>.</span>len <span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>
  <span style='color:#603000;'>memcpy</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>ctx<span style='color:#808030;'>.</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> h<span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
  
  <span style='color:#696969;'>// update state with input</span>
  idx <span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>
  
  <span style='color:#800000;font-weight:bold;'>do</span> <span style='color:#800080;'>{</span>
    <span style='color:#696969;'>// last block?</span>
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>inlen<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      <span style='color:#696969;'>// add the end bit</span>
      ctx<span style='color:#808030;'>.</span>buffer<span style='color:#808030;'>.</span>v8<span style='color:#808030;'>[</span>idx<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> <span style='color:#008000;'>0x80</span><span style='color:#800080;'>;</span>
      <span style='color:#696969;'>// zero the remainder of buffer</span>
      <span style='color:#603000;'>memset</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>ctx<span style='color:#808030;'>.</span>buffer<span style='color:#808030;'>.</span>v8<span style='color:#808030;'>[</span>idx<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>(</span><span style='color:#008c00;'>64</span> <span style='color:#808030;'>-</span> idx<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      <span style='color:#696969;'>// equal or exceed where to store total bits?</span>
      <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>idx <span style='color:#808030;'>&gt;</span><span style='color:#808030;'>=</span> <span style='color:#008c00;'>56</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
        <span style='color:#696969;'>// compress it</span>
        SHA256_Transform <span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>SHA256_CTX<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span><span style='color:#808030;'>&amp;</span>ctx<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
        <span style='color:#696969;'>// zero buffer</span>
        <span style='color:#603000;'>memset</span> <span style='color:#808030;'>(</span>ctx<span style='color:#808030;'>.</span>buffer<span style='color:#808030;'>.</span>v8<span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>64</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      <span style='color:#800080;'>}</span>
      <span style='color:#696969;'>// add total bits</span>
      ctx<span style='color:#808030;'>.</span>buffer<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>15</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> SWAP32 <span style='color:#808030;'>(</span>ctx<span style='color:#808030;'>.</span>len <span style='color:#808030;'>*</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      idx<span style='color:#808030;'>=</span><span style='color:#008c00;'>64</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span>
    <span style='color:#800080;'>{</span>    
      ctx<span style='color:#808030;'>.</span>buffer<span style='color:#808030;'>.</span>v8<span style='color:#808030;'>[</span>idx<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> <span style='color:#808030;'>*</span>p<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#800080;'>;</span>
      ctx<span style='color:#808030;'>.</span>len<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>idx<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span><span style='color:#008c00;'>64</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      <span style='color:#696969;'>// compress</span>
      SHA256_Transform <span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>SHA256_CTX<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span><span style='color:#808030;'>&amp;</span>ctx<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      idx<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
  <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>while</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>-</span><span style='color:#808030;'>-</span>inlen <span style='color:#808030;'>!</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>-</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
  
  <span style='color:#696969;'>// swap byte order and return</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    <span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>out<span style='color:#808030;'>)</span><span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> SWAP32 <span style='color:#808030;'>(</span>ctx<span style='color:#808030;'>.</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

The x86 assembler version in 588 bytes.

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; context</span>
sha256_ctx <span style='color:#004a43;'>struct</span>
  state  <span style='color:#004a43;'>dd</span> <span style='color:#008c00;'>8</span> <span style='color:#004a43;'>dup</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>?</span><span style='color:#808030;'>)</span>
  len    <span style='color:#004a43;'>dd</span> <span style='color:#808030;'>?</span>
  buffer <span style='color:#004a43;'>db</span> <span style='color:#008c00;'>64</span> <span style='color:#004a43;'>dup</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>?</span><span style='color:#808030;'>)</span>
sha256_ctx <span style='color:#004a43;'>ends</span>

SHA2<span style='color:#008c00;'>56</span> <span style='color:#004a43;'>proc</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>

    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>fstcw</span>  <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span>            <span style='color:#696969;'>; store control word</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>or</span>     <span style='color:#000080;'>ax</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>00400H</span>       <span style='color:#696969;'>; set round down bit</span>
    <span style='color:#800000;font-weight:bold;'>and</span>    <span style='color:#000080;'>ax</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0F7FFH</span>       <span style='color:#696969;'>; clear bit</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>fldcw</span>  <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span>            <span style='color:#696969;'>; load control word</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span>

    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>          <span style='color:#696969;'>; </span>
    <span style='color:#800000;font-weight:bold;'>sub</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#008c00;'>+64</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span>     <span style='color:#696969;'>; alloc space for ctx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edi</span>               <span style='color:#696969;'>; save ptr to ctx</span>
    
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>8</span>                 <span style='color:#696969;'>; load 8 32-bit words</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>load_iv</span>
  <span style='color:#004a43;'>dd</span> <span style='color:#008000;'>06a09e667h</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0bb67ae85h</span> 
  <span style='color:#004a43;'>dd</span> <span style='color:#008000;'>03c6ef372h</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0a54ff53ah</span>
  <span style='color:#004a43;'>dd</span> <span style='color:#008000;'>0510e527fh</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>09b05688ch</span>
  <span style='color:#004a43;'>dd</span> <span style='color:#008000;'>01f83d9abh</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>05be0cd19h</span>
<span style='color:#e34adc;'>load_iv:</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>esi</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsd</span>
    
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>                    <span style='color:#696969;'>; ctx.len = 0</span>
    <span style='color:#800000;font-weight:bold;'>cdq</span>                      <span style='color:#696969;'>; idx = 0</span>
    
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>  <span style='color:#696969;'>; ecx = inlen</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>  <span style='color:#696969;'>; esi = in</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+12</span><span style='color:#808030;'>]</span>  <span style='color:#696969;'>; ebx = out</span>
<span style='color:#e34adc;'>chk_len:</span>
    <span style='color:#800000;font-weight:bold;'>test</span>   <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebp</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>upd_buf</span>
    
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>80h</span>           <span style='color:#696969;'>; ctx.buffer[idx++] = 0x80;</span>
    <span style='color:#800000;font-weight:bold;'>stosb</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>neg</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>63</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>stosb</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>
    
    <span style='color:#696969;'>; if (edx &gt;= 56)</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>56</span>
    <span style='color:#800000;font-weight:bold;'>jb</span>     <span style='color:#e34adc;'>add_bits</span>
    
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>SHA256_Transform</span>
    
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edi</span>               <span style='color:#696969;'>; zero ctx.buffer</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>64</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>stosb</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>
    
<span style='color:#e34adc;'>add_bits:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>      <span style='color:#696969;'>; eax = ctx.len</span>
    <span style='color:#800000;font-weight:bold;'>shl</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span>            <span style='color:#696969;'>; multiply by 8</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>               <span style='color:#696969;'>; convert to big endian</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>60</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>     <span style='color:#696969;'>; save in buffer</span>
    <span style='color:#800000;font-weight:bold;'>jmp</span>    <span style='color:#e34adc;'>upd_ctx</span>
<span style='color:#e34adc;'>upd_buf:</span>
    <span style='color:#800000;font-weight:bold;'>lodsb</span>                    <span style='color:#696969;'>; al = *p++</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>  <span style='color:#696969;'>; ctx.len++</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>               <span style='color:#696969;'>; idx++</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>64</span>           <span style='color:#696969;'>; buffer full?</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>upd_len</span>
<span style='color:#e34adc;'>upd_ctx:</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>SHA256_Transform</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>          <span style='color:#696969;'>; idx=0</span>
<span style='color:#e34adc;'>upd_len:</span>
    <span style='color:#800000;font-weight:bold;'>dec</span>    <span style='color:#000080;'>ebp</span>               <span style='color:#696969;'>; while (--inlen &gt;= 0)</span>
    <span style='color:#800000;font-weight:bold;'>jns</span>    <span style='color:#e34adc;'>chk_len</span>

    <span style='color:#800000;font-weight:bold;'>mov</span>   <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>           <span style='color:#696969;'>; edi = out</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>   <span style='color:#000080;'>esi</span>                <span style='color:#696969;'>; esi = ctx.state</span>
    <span style='color:#800000;font-weight:bold;'>push</span>  <span style='color:#008c00;'>8</span>                  <span style='color:#696969;'>; save 256-bit state/hash</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>   <span style='color:#000080;'>ecx</span>
<span style='color:#e34adc;'>save_state:</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>                    <span style='color:#696969;'>; load word</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>               <span style='color:#696969;'>; convert to little endian</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>                    <span style='color:#696969;'>; save in out buffer</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>save_state</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#008c00;'>+64</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span>     <span style='color:#696969;'>; fix up stack</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
SHA2<span style='color:#008c00;'>56</span> <span style='color:#004a43;'>endp</span>
</pre>

Because there are 8 32-bit values and only 8 32-bit general purpose registers on x86 in 32-bit mode, the stack is used much more than I would have liked but it can't be helped.

<pre style='color:#000000;background:#ffffff;'>s0 <span style='color:#004a43;'>equ</span> <span style='color:#808030;'>&lt;</span><span style='color:#000080;'>eax</span><span style='color:#808030;'>&gt;</span>
s1 <span style='color:#004a43;'>equ</span> <span style='color:#808030;'>&lt;</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>&gt;</span>
i  <span style='color:#004a43;'>equ</span> <span style='color:#808030;'>&lt;</span><span style='color:#000080;'>ecx</span><span style='color:#808030;'>&gt;</span>
t1 <span style='color:#004a43;'>equ</span> <span style='color:#808030;'>&lt;</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>&gt;</span>
t2 <span style='color:#004a43;'>equ</span> <span style='color:#808030;'>&lt;</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>&gt;</span>
t3 <span style='color:#004a43;'>equ</span> <span style='color:#808030;'>&lt;</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>&gt;</span>

_a <span style='color:#004a43;'>textequ</span> <span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>[</span>sha256_ws.h<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#808030;'>&gt;</span>
_b <span style='color:#004a43;'>textequ</span> <span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>[</span>sha256_ws.h<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#808030;'>&gt;</span>
_c <span style='color:#004a43;'>textequ</span> <span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>[</span>sha256_ws.h<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#808030;'>&gt;</span>
_d <span style='color:#004a43;'>textequ</span> <span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>[</span>sha256_ws.h<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#808030;'>&gt;</span>
_e <span style='color:#004a43;'>textequ</span> <span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>[</span>sha256_ws.h<span style='color:#808030;'>[</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#808030;'>&gt;</span>
_f <span style='color:#004a43;'>textequ</span> <span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>[</span>sha256_ws.h<span style='color:#808030;'>[</span><span style='color:#008c00;'>5</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#808030;'>&gt;</span>
_g <span style='color:#004a43;'>textequ</span> <span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>[</span>sha256_ws.h<span style='color:#808030;'>[</span><span style='color:#008c00;'>6</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#808030;'>&gt;</span>
_h <span style='color:#004a43;'>textequ</span> <span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>[</span>sha256_ws.h<span style='color:#808030;'>[</span><span style='color:#008c00;'>7</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#808030;'>&gt;</span>

<span style='color:#696969;'>; workspace for compression</span>
sha256_ws <span style='color:#004a43;'>struct</span>
  h <span style='color:#004a43;'>dd</span>  <span style='color:#008c00;'>8</span> <span style='color:#004a43;'>dup</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>?</span><span style='color:#808030;'>)</span>
  w <span style='color:#004a43;'>dd</span> <span style='color:#008c00;'>64</span> <span style='color:#004a43;'>dup</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>?</span><span style='color:#808030;'>)</span>
sha256_ws <span style='color:#004a43;'>ends</span>

SHA256_Transform <span style='color:#004a43;'>proc</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>    
    
     <span style='color:#696969;'>; save pointer to context</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span> <span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>esi</span>
    
    <span style='color:#696969;'>; allocate work space</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> sizeof sha256_ws
    
    <span style='color:#696969;'>; Initialize working variables </span>
    <span style='color:#696969;'>; to current hash value:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsd</span>
    <span style='color:#696969;'>; skip len</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    
    <span style='color:#696969;'>; convert 16 words to big endian</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
<span style='color:#e34adc;'>swap_bytes:</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>swap_bytes</span>

    <span style='color:#696969;'>; Extend the first 16 words into the </span>
    <span style='color:#696969;'>; remaining 48 words w[16..63] of </span>
    <span style='color:#696969;'>; the message schedule array:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>48</span>
<span style='color:#e34adc;'>expand:</span>
    <span style='color:#696969;'>; s0 := (w[i-15] rightrotate 7) </span>
    <span style='color:#696969;'>;   xor (w[i-15] rightrotate 18) </span>
    <span style='color:#696969;'>;   xor (w[i-15] rightshift 3)</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    s0<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span> <span style='color:#808030;'>-</span> <span style='color:#008c00;'>15</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    t1<span style='color:#808030;'>,</span> s0
    <span style='color:#800000;font-weight:bold;'>mov</span>    t2<span style='color:#808030;'>,</span> s0
    <span style='color:#800000;font-weight:bold;'>ror</span>    s0<span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>
    <span style='color:#800000;font-weight:bold;'>ror</span>    t1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>18</span>
    <span style='color:#800000;font-weight:bold;'>shr</span>    t2<span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    s0<span style='color:#808030;'>,</span> t1
    <span style='color:#800000;font-weight:bold;'>xor</span>    s0<span style='color:#808030;'>,</span> t2
    <span style='color:#696969;'>; s1 := (w[i-2] rightrotate 17) </span>
    <span style='color:#696969;'>;   xor (w[i-2] rightrotate 19) </span>
    <span style='color:#696969;'>;   xor (w[i-2] rightshift 10)</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    s1<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span> <span style='color:#808030;'>-</span> <span style='color:#008c00;'>2</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    t1<span style='color:#808030;'>,</span> s1
    <span style='color:#800000;font-weight:bold;'>mov</span>    t2<span style='color:#808030;'>,</span> s1
    <span style='color:#800000;font-weight:bold;'>ror</span>    s1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>17</span>
    <span style='color:#800000;font-weight:bold;'>ror</span>    t1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>19</span>
    <span style='color:#800000;font-weight:bold;'>shr</span>    t2<span style='color:#808030;'>,</span> <span style='color:#008c00;'>10</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    s1<span style='color:#808030;'>,</span> t1
    <span style='color:#800000;font-weight:bold;'>xor</span>    s1<span style='color:#808030;'>,</span> t2
    <span style='color:#696969;'>; w[i] := w[i-16] + s0 + w[i-7] + s1</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    s0<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span> <span style='color:#808030;'>-</span> <span style='color:#008c00;'>16</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    s1<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span> <span style='color:#808030;'>-</span>  <span style='color:#008c00;'>7</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    s0<span style='color:#808030;'>,</span> s1
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>expand</span>
    
    <span style='color:#696969;'>; update context</span>
<span style='color:#e34adc;'>update_loop:</span>
    <span style='color:#696969;'>; S1 := EP1(e)</span>
    
    <span style='color:#696969;'>; S1 := (e rightrotate 6) </span>
    <span style='color:#696969;'>;   xor (e rightrotate 11) </span>
    <span style='color:#696969;'>;   xor (e rightrotate 25)</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    s1<span style='color:#808030;'>,</span> _e
    <span style='color:#800000;font-weight:bold;'>mov</span>    t1<span style='color:#808030;'>,</span> s1
    <span style='color:#800000;font-weight:bold;'>ror</span>    s1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>25</span>
    <span style='color:#800000;font-weight:bold;'>ror</span>    t1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>6</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    s1<span style='color:#808030;'>,</span> t1
    <span style='color:#800000;font-weight:bold;'>ror</span>    t1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#008c00;'>-6</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    s1<span style='color:#808030;'>,</span> t1
    <span style='color:#696969;'>; CH(e, f, g)</span>
    <span style='color:#696969;'>; ch := (e and f) xor ((not e) and g)</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    t1<span style='color:#808030;'>,</span> _f
    <span style='color:#800000;font-weight:bold;'>xor</span>    t1<span style='color:#808030;'>,</span> _g
    <span style='color:#800000;font-weight:bold;'>and</span>    t1<span style='color:#808030;'>,</span> _e
    <span style='color:#800000;font-weight:bold;'>xor</span>    t1<span style='color:#808030;'>,</span> _g
    <span style='color:#696969;'>; temp1 := h + S1 + ch + k[i] + w[i]</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    t1<span style='color:#808030;'>,</span> s1
    <span style='color:#800000;font-weight:bold;'>add</span>    t1<span style='color:#808030;'>,</span> _h
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>cbr2int</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    t1<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    t1<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>[</span>sha256_ws.w<span style='color:#808030;'>[</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>]</span>
    <span style='color:#696969;'>; S0 := EP0(a)</span>
    <span style='color:#696969;'>; S0 := (a rightrotate 2) </span>
    <span style='color:#696969;'>;   xor (a rightrotate 13) </span>
    <span style='color:#696969;'>;   xor (a rightrotate 22)</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    s0<span style='color:#808030;'>,</span> _a
    <span style='color:#800000;font-weight:bold;'>mov</span>    t2<span style='color:#808030;'>,</span> s0
    <span style='color:#800000;font-weight:bold;'>ror</span>    s0<span style='color:#808030;'>,</span> <span style='color:#008c00;'>22</span>
    <span style='color:#800000;font-weight:bold;'>ror</span>    t2<span style='color:#808030;'>,</span> <span style='color:#008c00;'>2</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    s0<span style='color:#808030;'>,</span> t2
    <span style='color:#800000;font-weight:bold;'>ror</span>    t2<span style='color:#808030;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#008c00;'>-2</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    s0<span style='color:#808030;'>,</span> t2
    <span style='color:#696969;'>; MAJ(a, b, c)</span>
    <span style='color:#696969;'>; maj := (a and b) xor (a and c) xor (b and c)</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    t2<span style='color:#808030;'>,</span> _a
    <span style='color:#800000;font-weight:bold;'>mov</span>    t3<span style='color:#808030;'>,</span> _a
    <span style='color:#800000;font-weight:bold;'>or</span>     t2<span style='color:#808030;'>,</span> _b
    <span style='color:#800000;font-weight:bold;'>and</span>    t2<span style='color:#808030;'>,</span> _c
    <span style='color:#800000;font-weight:bold;'>and</span>    t3<span style='color:#808030;'>,</span> _b
    <span style='color:#800000;font-weight:bold;'>or</span>     t2<span style='color:#808030;'>,</span> t3
    <span style='color:#696969;'>; temp2 := S0 + maj</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    t2<span style='color:#808030;'>,</span> s0
    <span style='color:#696969;'>; d = d + temp1</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    _d<span style='color:#808030;'>,</span> t1
    <span style='color:#696969;'>; h = temp1 + temp2</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    _h<span style='color:#808030;'>,</span> t1
    <span style='color:#800000;font-weight:bold;'>add</span>    _h<span style='color:#808030;'>,</span> t2
    <span style='color:#696969;'>; shift state</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>    
    <span style='color:#800000;font-weight:bold;'>push</span>   i
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>                   <span style='color:#696969;'>; load a</span>
<span style='color:#e34adc;'>shift_state:</span>
    <span style='color:#800000;font-weight:bold;'>scasd</span>                   <span style='color:#696969;'>; skip a</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span>       <span style='color:#696969;'>; </span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>shift_state</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    i
    
    <span style='color:#696969;'>; i++</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    i
    <span style='color:#800000;font-weight:bold;'>cmp</span>    i<span style='color:#808030;'>,</span> <span style='color:#008c00;'>64</span>
    <span style='color:#800000;font-weight:bold;'>jne</span>    <span style='color:#e34adc;'>update_loop</span>
    
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> sizeof sha256_ws
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
<span style='color:#e34adc;'>save_state:</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>save_state</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
SHA256_Transform <span style='color:#004a43;'>endp</span>
</pre>

I discussed how to <a href="https://tinycrypt.wordpress.com/2015/11/03/md5-t-and-sha-256-k-constants/">generate the K constants</a> using FPU because it saves a number of bytes.

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; get cubic root of number </span>
    <span style='color:#696969;'>; return 32-bit fractional part as integer</span>
<span style='color:#e34adc;'>cbr2int:</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>1</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>0</span>
    <span style='color:#800000;font-weight:bold;'>fild</span>   <span style='color:#800000;font-weight:bold;'>qword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span>   <span style='color:#696969;'>; load 2^32</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>1</span>
    <span style='color:#800000;font-weight:bold;'>fild</span>   <span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>3</span>
    <span style='color:#800000;font-weight:bold;'>fild</span>   <span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>fdivp</span>                   <span style='color:#696969;'>; 1.0/3.0</span>
    <span style='color:#800000;font-weight:bold;'>movzx</span>  <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>word</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span>primes<span style='color:#808030;'>+</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>*</span>i<span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>fild</span>   <span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span>   <span style='color:#696969;'>;</span>
    <span style='color:#800000;font-weight:bold;'>fyl2x</span>                   <span style='color:#696969;'>; -&gt;log2(Src1)*exponent</span>
    <span style='color:#800000;font-weight:bold;'>fld</span>    <span style='color:#000080;'>st</span><span style='color:#808030;'>(</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span>            <span style='color:#696969;'>; copy the logarithm</span>
    <span style='color:#800000;font-weight:bold;'>frndint</span>                 <span style='color:#696969;'>; keep only the characteristic</span>
    <span style='color:#800000;font-weight:bold;'>fsub</span>   <span style='color:#000080;'>st</span><span style='color:#808030;'>(</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>st</span>        <span style='color:#696969;'>; keeps only the mantissa</span>
    <span style='color:#800000;font-weight:bold;'>fxch</span>                    <span style='color:#696969;'>; get the mantissa on top</span>
    <span style='color:#800000;font-weight:bold;'>f2xm1</span>                   <span style='color:#696969;'>; -&gt;2^(mantissa)-1</span>
    <span style='color:#800000;font-weight:bold;'>fscale</span>
    <span style='color:#800000;font-weight:bold;'>fstp</span>   <span style='color:#000080;'>st</span><span style='color:#808030;'>(</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span>            <span style='color:#696969;'>; copy result over and "pop" it</span>
    <span style='color:#800000;font-weight:bold;'>fmul</span>                    <span style='color:#696969;'>; * 2^32</span>
    <span style='color:#800000;font-weight:bold;'>fistp</span>  <span style='color:#800000;font-weight:bold;'>qword</span> <span style='color:#800000;font-weight:bold;'>ptr</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span>   <span style='color:#696969;'>; save integer</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span>         <span style='color:#696969;'>; release stack</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>

primes <span style='color:#004a43;'>dw</span> <span style='color:#008c00;'>2</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>17</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>19</span>
       <span style='color:#004a43;'>dw</span> <span style='color:#008c00;'>23</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>29</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>31</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>37</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>41</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>43</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>47</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>53</span>
       <span style='color:#004a43;'>dw</span> <span style='color:#008c00;'>59</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>61</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>67</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>71</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>73</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>79</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>83</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>89</span>
       <span style='color:#004a43;'>dw</span> <span style='color:#008c00;'>97</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>101</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>103</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>107</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>109</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>113</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>127</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>131</span>
       <span style='color:#004a43;'>dw</span> <span style='color:#008c00;'>137</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>139</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>149</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>151</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>157</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>163</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>167</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>173</span>
       <span style='color:#004a43;'>dw</span> <span style='color:#008c00;'>179</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>181</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>191</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>193</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>197</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>199</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>211</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>223</span> 
       <span style='color:#004a43;'>dw</span> <span style='color:#008c00;'>227</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>229</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>233</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>239</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>241</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>251</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>257</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>263</span>
       <span style='color:#004a43;'>dw</span> <span style='color:#008c00;'>269</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>271</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>277</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>281</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>283</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>293</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>307</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>311</span>
primes_len <span style='color:#004a43;'>equ</span> $<span style='color:#808030;'>-</span>primes
</pre>

<h2>Summary</h2>

<table>
<tr><th>architecture</th><th>algorithm</th><th>size</th></tr>
<tr>
<td>x86</td>
<td>SHA-256 (integrated version with dynamic k)</td>
<td>588</td>
</tr>
<tr>
<td>x86</td>
<td>SHA-256 (dynamic k + h)</td>
<td>666</td>
</tr>
<tr>
<td>x86</td>
<td>SHA-256 (static k + h)</td>
<td>710</td>
</tr>
</table>

There are a few additional tweaks that might shave off a few bytes but nothing significant, at least not that I can see but leave some feedback if you manage to reduce it further.

<a href="https://github.com/odzhan/tinycrypt/tree/master/hash/sha2">sources here on github</a>
