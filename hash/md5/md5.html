<strong>Introduction</strong>

<a href="https://www.ietf.org/rfc/rfc1321.txt">The MD5 Message-Digest Algorithm</a> published in 1992 by Ron Rivest was his successor to MD4 which I've discussed previously. Some security considerations for this algorithm are detailed in <a href="https://tools.ietf.org/rfc/rfc6151.txt">RFC 6151</a> published in 2011.

It is undoubtedly the most famous hashing algorithm around and still used in many applications although is being phased out in favour of SHA-256 and others.

I have already discussed the generation of T constants here. The initialization, update and finalization are exact same as MD4 discussed earlier.

The transform/compression function looks like

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>void</span> MD5_Transform <span style='color:#808030;'>(</span>MD5_CTX<span style='color:#808030;'>*</span> ctx<span style='color:#808030;'>)</span> 
<span style='color:#800080;'>{</span>
  uint32_t a<span style='color:#808030;'>,</span> b<span style='color:#808030;'>,</span> c<span style='color:#808030;'>,</span> d<span style='color:#808030;'>,</span> i<span style='color:#808030;'>,</span> t<span style='color:#808030;'>,</span> x<span style='color:#808030;'>,</span> s<span style='color:#800080;'>;</span>

  a <span style='color:#808030;'>=</span> ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  b <span style='color:#808030;'>=</span> ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  c <span style='color:#808030;'>=</span> ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  d <span style='color:#808030;'>=</span> ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>64</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
<span style='color:#004a43;'>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43;'>#</span><span style='color:#004a43;'>ifdef</span><span style='color:#004a43;'> DYNAMIC</span>
      t<span style='color:#808030;'>=</span>tc<span style='color:#808030;'>(</span>i<span style='color:#808030;'>+</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#004a43;'>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43;'>#</span><span style='color:#004a43;'>else</span>
      t<span style='color:#808030;'>=</span>tc<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
<span style='color:#004a43;'>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43;'>#</span><span style='color:#004a43;'>endif</span>
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>i <span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      s <span style='color:#808030;'>=</span> rotf<span style='color:#808030;'>[</span>i<span style='color:#808030;'>%</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
      a <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> F <span style='color:#808030;'>(</span>b<span style='color:#808030;'>,</span> c<span style='color:#808030;'>,</span> d<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>i <span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>32</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      s <span style='color:#808030;'>=</span> rotg<span style='color:#808030;'>[</span>i<span style='color:#808030;'>%</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
      a <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> G <span style='color:#808030;'>(</span>b<span style='color:#808030;'>,</span> c<span style='color:#808030;'>,</span> d<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>i <span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>48</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      s <span style='color:#808030;'>=</span> roth<span style='color:#808030;'>[</span>i<span style='color:#808030;'>%</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
      a <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> H <span style='color:#808030;'>(</span>b<span style='color:#808030;'>,</span> c<span style='color:#808030;'>,</span> d<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800080;'>{</span>
      s <span style='color:#808030;'>=</span> roti<span style='color:#808030;'>[</span>i<span style='color:#808030;'>%</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
      a <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> I <span style='color:#808030;'>(</span>b<span style='color:#808030;'>,</span> c<span style='color:#808030;'>,</span> d<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    a <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>data<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span>sigma<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span> t<span style='color:#800080;'>;</span>
    a <span style='color:#808030;'>=</span> ROL32<span style='color:#808030;'>(</span>a<span style='color:#808030;'>,</span> s<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    a <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> b<span style='color:#800080;'>;</span>
    t<span style='color:#808030;'>=</span>a<span style='color:#800080;'>;</span>
    a<span style='color:#808030;'>=</span>d<span style='color:#800080;'>;</span>
    d<span style='color:#808030;'>=</span>c<span style='color:#800080;'>;</span>
    c<span style='color:#808030;'>=</span>b<span style='color:#800080;'>;</span>
    b<span style='color:#808030;'>=</span>t<span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>

  ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> a<span style='color:#800080;'>;</span>
  ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> b<span style='color:#800080;'>;</span>
  ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> c<span style='color:#800080;'>;</span>
  ctx<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>state<span style='color:#808030;'>.</span>v32<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> d<span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>
</pre>

The function in assembly is very similar to MD4 again but this time with the option of generating T constants dynamically.

<pre style='color:#000000;background:#ffffff;'>MD5_Transform <span style='color:#004a43;'>proc</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
<span style='color:#004a43;'>ifdef</span> DYNAMIC
    <span style='color:#696969;'>; set control word to round down numbers</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>init_fpu</span>
<span style='color:#004a43;'>endif</span>
    <span style='color:#696969;'>; load context</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>  <span style='color:#696969;'>; ctx</span>
    
    <span style='color:#696969;'>; a = ctx-&gt;state.v32[0]</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   _d<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#696969;'>; b = ctx-&gt;state.v32[1]</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   _b<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#696969;'>; c = ctx-&gt;state.v32[2]</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   _c<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#696969;'>; d = ctx-&gt;state.v32[3]</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   _d<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>esi</span>         <span style='color:#696969;'>; x</span>
    
    <span style='color:#800000;font-weight:bold;'>xor</span>    _i<span style='color:#808030;'>,</span> _i
    
    <span style='color:#004a43;'>.repeat</span>
       <span style='color:#800000;font-weight:bold;'>mov</span>    t1<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span>
       <span style='color:#800000;font-weight:bold;'>movzx</span>  t2<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>byte</span> <span style='color:#800000;font-weight:bold;'>ptr</span> idx<span style='color:#808030;'>[</span>_i<span style='color:#808030;'>]</span>     <span style='color:#696969;'>; idx[i]</span>
       <span style='color:#800000;font-weight:bold;'>add</span>    _a<span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span>t1<span style='color:#008c00;'>+4</span><span style='color:#808030;'>*</span>t2<span style='color:#808030;'>]</span>            <span style='color:#696969;'>; a += x[i]</span>
       <span style='color:#800000;font-weight:bold;'>mov</span>    t2<span style='color:#808030;'>,</span> _i
       <span style='color:#800000;font-weight:bold;'>and</span>    t2<span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span>                    <span style='color:#696969;'>; i %= 4</span>
       <span style='color:#800000;font-weight:bold;'>mov</span>    t1<span style='color:#808030;'>,</span> _c
      <span style='color:#004a43;'>.if</span>     _i <span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>16</span>
        <span style='color:#800000;font-weight:bold;'>mov</span>   <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>byte</span> <span style='color:#800000;font-weight:bold;'>ptr</span> rotf<span style='color:#808030;'>[</span>t2<span style='color:#808030;'>]</span>    <span style='color:#696969;'>; rotf[i%4]</span>
        <span style='color:#800000;font-weight:bold;'>xor</span>   t1<span style='color:#808030;'>,</span> _d
        <span style='color:#800000;font-weight:bold;'>and</span>   t1<span style='color:#808030;'>,</span> _b
        <span style='color:#800000;font-weight:bold;'>xor</span>   t1<span style='color:#808030;'>,</span> _d
      <span style='color:#004a43;'>.elseif</span> _i <span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>32</span>
        <span style='color:#800000;font-weight:bold;'>mov</span>   <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>byte</span> <span style='color:#800000;font-weight:bold;'>ptr</span> rotg<span style='color:#808030;'>[</span>t2<span style='color:#808030;'>]</span>    <span style='color:#696969;'>; rotg[i%4]</span>
        <span style='color:#800000;font-weight:bold;'>xor</span>   t1<span style='color:#808030;'>,</span> _b
        <span style='color:#800000;font-weight:bold;'>and</span>   t1<span style='color:#808030;'>,</span> _d
        <span style='color:#800000;font-weight:bold;'>xor</span>   t1<span style='color:#808030;'>,</span> _c
      <span style='color:#004a43;'>.elseif</span> _i <span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>48</span>
        <span style='color:#800000;font-weight:bold;'>mov</span>   <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>byte</span> <span style='color:#800000;font-weight:bold;'>ptr</span> roth<span style='color:#808030;'>[</span>t2<span style='color:#808030;'>]</span>    <span style='color:#696969;'>; roth[i%4]</span>
        <span style='color:#800000;font-weight:bold;'>xor</span>   t1<span style='color:#808030;'>,</span> _d
        <span style='color:#800000;font-weight:bold;'>xor</span>   t1<span style='color:#808030;'>,</span> _b
      <span style='color:#004a43;'>.else</span>
        <span style='color:#800000;font-weight:bold;'>mov</span>   <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>byte</span> <span style='color:#800000;font-weight:bold;'>ptr</span> roti<span style='color:#808030;'>[</span>t2<span style='color:#808030;'>]</span>
        <span style='color:#800000;font-weight:bold;'>mov</span>   t1<span style='color:#808030;'>,</span> _d
        <span style='color:#800000;font-weight:bold;'>xor</span>   t1<span style='color:#808030;'>,</span> <span style='color:#008c00;'>-1</span>
        <span style='color:#800000;font-weight:bold;'>or</span>    t1<span style='color:#808030;'>,</span> _b
        <span style='color:#800000;font-weight:bold;'>xor</span>   t1<span style='color:#808030;'>,</span> _c
      <span style='color:#004a43;'>.endif</span>
      
      <span style='color:#800000;font-weight:bold;'>add</span>    _a<span style='color:#808030;'>,</span> t1
<span style='color:#004a43;'>ifdef</span> DYNAMIC
      <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>sin2int</span>
<span style='color:#004a43;'>else</span>
      <span style='color:#800000;font-weight:bold;'>mov</span>    t1<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>dword</span> <span style='color:#800000;font-weight:bold;'>ptr</span> tc<span style='color:#808030;'>[</span>_i<span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
<span style='color:#004a43;'>endif</span>
      <span style='color:#800000;font-weight:bold;'>add</span>    _a<span style='color:#808030;'>,</span> t1
      <span style='color:#800000;font-weight:bold;'>rol</span>    _a<span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>
      <span style='color:#800000;font-weight:bold;'>add</span>    _a<span style='color:#808030;'>,</span> _b
      
      <span style='color:#800000;font-weight:bold;'>mov</span>    t1<span style='color:#808030;'>,</span> _a
      <span style='color:#800000;font-weight:bold;'>mov</span>    _a<span style='color:#808030;'>,</span> _d
      <span style='color:#800000;font-weight:bold;'>mov</span>    _d<span style='color:#808030;'>,</span> _c
      <span style='color:#800000;font-weight:bold;'>mov</span>    _c<span style='color:#808030;'>,</span> _b
      <span style='color:#800000;font-weight:bold;'>mov</span>    _b<span style='color:#808030;'>,</span> t1
      
      <span style='color:#800000;font-weight:bold;'>inc</span>    _i
    <span style='color:#004a43;'>.until</span> _i <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> MD5_CBLOCK
    
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>esi</span>
    
    <span style='color:#696969;'>; restore registers</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>
    <span style='color:#696969;'>; save context</span>
    <span style='color:#696969;'>; ctx-&gt;state.v32[0] += a;</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> _a
    <span style='color:#800000;font-weight:bold;'>scasd</span>
    <span style='color:#696969;'>; ctx-&gt;state.v32[1] += b;</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> _b
    <span style='color:#800000;font-weight:bold;'>scasd</span>
    <span style='color:#696969;'>; ctx-&gt;state.v32[2] += c;</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> _c
    <span style='color:#800000;font-weight:bold;'>scasd</span>
    <span style='color:#696969;'>; ctx-&gt;state.v32[3] += d;</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> _d
    <span style='color:#696969;'>; restore registers</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>retn</span>   <span style='color:#008c00;'>4</span>
MD5_Transform <span style='color:#004a43;'>endp</span>
</pre>

<strong>Summary</strong>

<table>
<tr>
<th>architecture</th><th>size</th>
</tr>
<tr><td>x86</td><td>479 (dynamic T values)</td></tr>
<tr><td>x86</td><td>685 (static T values)</td></tr>
<tr><td>x64</td><td>585 (dynamic T values)</td></tr>
<tr><td>x64</td><td>782 (static T values)</td></tr>
</table>

The main problem again with this algorithm is how to implement in device that has low resources.
The size of this code in x86 is 485 bytes and slightly larger when you include array of 64 constants.

See <a href="https://github.com/odzhan/tinycrypt/tree/master/hash/md5">sources here</a>
