<h3><strong>Introduction</strong></h3>

<p><a href="https://blake2.net/">BLAKE2</a> is a cryptographic hash and Message Authentication Code (MAC) that was designed by <a href="https://131002.net/">Jean-Philippe Aumasson</a>, <a href="https://eden.dei.uc.pt/~sneves/">Samuel Neves</a>, <a href="https://en.wikipedia.org/wiki/Zooko_Wilcox-O'Hearn">Zooko Wilcox-O'Hearn</a>, and <a href="https://codesinchaos.wordpress.com/">Christian Winnerlein</a>. It was published in 200</p>

BLAKE2 comes in two basic flavors:
<ul>
	<li>BLAKE2b (or just BLAKE2) is optimized for 64-bit platforms and produces digests of any size between 1 and 64 bytes.</li>
	<li>BLAKE2s is optimized for 8- to 32-bit platforms and produces digests of any size between 1 and 32 bytes.</li>
</ul>

Only BLAKE2s was implemented in x86 assembly for now. BLAKE2b may be written in x64 assembly at a later date.

The version in C is derived from <a href="https://tools.ietf.org/rfc/rfc7693.txt">RFC 7693</a> by <a href="https://mjos.fi/">Markku-Juhani O. Saarinen</a> but only tested on x86 architecture. The x86 assembly was a joint effort between <a href="http://pferrie.host22.com/">Peter Ferrie</a> and myself.

<h3><strong>Initialization Vector</strong></h3>

The initialization vector is exactly the same as <a href="https://tinycrypt.wordpress.com/2015/11/03/md5-t-and-sha-256-k-constants/">SHA-256.</a>
There are 8 32-bit integers derived from the square root of the first 8 prime numbers (2, 3, 5, 7, 11, 13, 17, 19)

<pre style='color:#000020;background:#f6f8ff;'><span style='color:#200080;font-weight:bold;'>static</span> <span style='color:#200080;font-weight:bold;'>const</span> uint32_t blake2s_iv<span style='color:#308080;'>[</span><span style='color:#008c00;'>8</span><span style='color:#308080;'>]</span> <span style='color:#308080;'>=</span>
   <span style='color:#406080;'>{</span>
       <span style='color:#008000;'>0x6A09E667</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0xBB67AE85</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0x3C6EF372</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0xA54FF53A</span><span style='color:#308080;'>,</span>
       <span style='color:#008000;'>0x510E527F</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0x9B05688C</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0x1F83D9AB</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0x5BE0CD19</span>
   <span style='color:#406080;'>}</span><span style='color:#406080;'>;</span>
</pre>

If you want to create on the fly, the following function will work (note some compilers require #pragma intrinsic (fabs,pow,sqrt))

<pre style='color:#000020;background:#f6f8ff;'>uint32_t sqrt2int <span style='color:#308080;'>(</span>uint32_t x<span style='color:#308080;'>)</span> <span style='color:#406080;'>{</span>
  uint32_t r<span style='color:#406080;'>;</span>
  r <span style='color:#308080;'>=</span> <span style='color:#308080;'>(</span>uint32_t<span style='color:#308080;'>)</span><span style='color:#308080;'>(</span><span style='color:#003060;'>fabs</span><span style='color:#308080;'>(</span><span style='color:#003060;'>sqrt</span><span style='color:#308080;'>(</span><span style='color:#308080;'>(</span><span style='color:#200080;font-weight:bold;'>double</span><span style='color:#308080;'>)</span>p<span style='color:#308080;'>[</span>x<span style='color:#308080;'>]</span><span style='color:#308080;'>)</span><span style='color:#308080;'>)</span><span style='color:#308080;'>*</span><span style='color:#003060;'>pow</span><span style='color:#308080;'>(</span><span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span><span style='color:#008c00;'>32</span><span style='color:#308080;'>)</span><span style='color:#308080;'>)</span><span style='color:#406080;'>;</span>
  <span style='color:#200080;font-weight:bold;'>return</span> r<span style='color:#406080;'>;</span>
<span style='color:#406080;'>}</span>
</pre>

And although the following isn't used in final assembly code, it's just to illustrate generation with the FPU. init_fpu must be called before sqrt2int

<pre style='color:#000020;background:#f6f8ff;'><span style='color:#e34adc;'>init_fpu:</span>
    <span style='color:#595979;'>; round numbers down</span>
    <span style='color:#200080;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>
    <span style='color:#200080;font-weight:bold;'>fstcw</span>  <span style='color:#308080;'>[</span><span style='color:#000080;'>esp</span><span style='color:#308080;'>]</span>            <span style='color:#595979;'>; store control word</span>
    <span style='color:#200080;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span>
    <span style='color:#200080;font-weight:bold;'>or</span>     <span style='color:#000080;'>ax</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>00400H</span>       <span style='color:#595979;'>; set round down bit</span>
    <span style='color:#200080;font-weight:bold;'>and</span>    <span style='color:#000080;'>ax</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0F7FFH</span>       <span style='color:#595979;'>; clear bit</span>
    <span style='color:#200080;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>
    <span style='color:#200080;font-weight:bold;'>fldcw</span>  <span style='color:#308080;'>[</span><span style='color:#000080;'>esp</span><span style='color:#308080;'>]</span>            <span style='color:#595979;'>; load control word</span>
    <span style='color:#200080;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span>
    <span style='color:#200080;font-weight:bold;'>ret</span>
    
<span style='color:#e34adc;'>sqrt2int:</span>
    <span style='color:#595979;'>; get square root of number in eax </span>
    <span style='color:#595979;'>; return 32-bit fractional part as integer</span>
    <span style='color:#200080;font-weight:bold;'>push</span>   <span style='color:#008c00;'>1</span>
    <span style='color:#200080;font-weight:bold;'>push</span>   <span style='color:#008c00;'>0</span>
    <span style='color:#200080;font-weight:bold;'>fild</span>   <span style='color:#200080;font-weight:bold;'>qword</span> <span style='color:#200080;font-weight:bold;'>ptr</span><span style='color:#308080;'>[</span><span style='color:#000080;'>esp</span><span style='color:#308080;'>]</span>   <span style='color:#595979;'>; load 2^32</span>
    <span style='color:#200080;font-weight:bold;'>movzx</span>  <span style='color:#000080;'>eax</span><span style='color:#308080;'>,</span> <span style='color:#200080;font-weight:bold;'>word</span> <span style='color:#200080;font-weight:bold;'>ptr</span><span style='color:#308080;'>[</span>primes<span style='color:#308080;'>+</span><span style='color:#008c00;'>2</span><span style='color:#308080;'>*</span>i<span style='color:#308080;'>]</span>
    <span style='color:#200080;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>
    <span style='color:#200080;font-weight:bold;'>fild</span>   <span style='color:#200080;font-weight:bold;'>dword</span> <span style='color:#200080;font-weight:bold;'>ptr</span><span style='color:#308080;'>[</span><span style='color:#000080;'>esp</span><span style='color:#308080;'>]</span>   <span style='color:#595979;'>; load integer</span>
    <span style='color:#200080;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>
    <span style='color:#200080;font-weight:bold;'>fsqrt</span>
    <span style='color:#200080;font-weight:bold;'>fld1</span>                    <span style='color:#595979;'>; load 1 </span>
    <span style='color:#200080;font-weight:bold;'>fsub</span>                    <span style='color:#595979;'>; subtract to get fractional part</span>
    <span style='color:#200080;font-weight:bold;'>fmul</span>                    <span style='color:#595979;'>; multiply fractional part by 2^32</span>
    <span style='color:#200080;font-weight:bold;'>frndint</span>
    <span style='color:#200080;font-weight:bold;'>fistp</span>  <span style='color:#200080;font-weight:bold;'>qword</span> <span style='color:#200080;font-weight:bold;'>ptr</span><span style='color:#308080;'>[</span><span style='color:#000080;'>esp</span><span style='color:#308080;'>]</span>
    <span style='color:#200080;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span> 
    <span style='color:#200080;font-weight:bold;'>add</span>    <span style='color:#000080;'>esp</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>*</span><span style='color:#008c00;'>4</span>         <span style='color:#595979;'>; release 2^32 on stack</span>
    <span style='color:#200080;font-weight:bold;'>ret</span>
</pre>

<strong>Initialization Function</strong>

To work as a MAC, supply a key not exceeding 32-bytes or 256-bits.

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// initialize context.</span>
<span style='color:#800000;font-weight:bold;'>void</span> b2s_init <span style='color:#808030;'>(</span>b2s_ctx <span style='color:#808030;'>*</span>c<span style='color:#808030;'>,</span> uint32_t outlen<span style='color:#808030;'>,</span> 
  <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>key<span style='color:#808030;'>,</span> uint32_t keylen<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    uint32_t i<span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// initialization vectors</span>
    uint32_t b2s_iv<span style='color:#808030;'>[</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span>
    <span style='color:#800080;'>{</span> <span style='color:#008000;'>0x6A09E667</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xBB67AE85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3C6EF372</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA54FF53A</span><span style='color:#808030;'>,</span>
      <span style='color:#008000;'>0x510E527F</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9B05688C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1F83D9AB</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5BE0CD19</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// outlen can't be zero or exceed 32 bytes</span>
    outlen<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>outlen<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span> <span style='color:#808030;'>|</span><span style='color:#808030;'>|</span> outlen<span style='color:#808030;'>&gt;</span><span style='color:#008c00;'>32</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>?</span> <span style='color:#008c00;'>32</span> <span style='color:#800080;'>:</span> outlen<span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// keylen can't exceed 32 bytes</span>
    keylen<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>keylen<span style='color:#808030;'>&gt;</span><span style='color:#008c00;'>32</span><span style='color:#808030;'>)</span>  <span style='color:#800080;'>?</span> <span style='color:#008c00;'>32</span> <span style='color:#800080;'>:</span> keylen<span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// set x to zero</span>
    <span style='color:#603000;'>memset</span><span style='color:#808030;'>(</span>c<span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>sizeof</span><span style='color:#808030;'>(</span>b2s_ctx<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// initialize s iv</span>
    <span style='color:#603000;'>memcpy</span><span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>s<span style='color:#808030;'>,</span> b2s_iv<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>sizeof</span><span style='color:#808030;'>(</span>b2s_iv<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// update s with keylen and outlen</span>
    c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>s<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> <span style='color:#008000;'>0x01010000</span> <span style='color:#808030;'>^</span> 
              <span style='color:#808030;'>(</span>keylen <span style='color:#808030;'>&lt;</span><span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> 
              outlen<span style='color:#800080;'>;</span>
   
    <span style='color:#696969;'>// set length to zero</span>
    c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>len<span style='color:#808030;'>.</span>q  <span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>
    <span style='color:#696969;'>// if key used, set idx to 64</span>
    c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>idx    <span style='color:#808030;'>=</span> keylen <span style='color:#800080;'>?</span> <span style='color:#008c00;'>64</span> <span style='color:#800080;'>:</span> <span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>
    c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>outlen <span style='color:#808030;'>=</span> outlen<span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// copy optional key</span>
    <span style='color:#603000;'>memcpy</span><span style='color:#808030;'>(</span>c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>,</span> key<span style='color:#808030;'>,</span> keylen<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>
</pre>

The assembly sticks close to the C version.


<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; void b2s_init (b2s_ctx *ctx, uint32_t outlen, </span>
<span style='color:#696969;'>;   void *key, uint32_t keylen)</span>
<span style='color:#e34adc;'>_b2s_initx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>

    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>    
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; ctx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; outlen</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+16</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; keylen</span>
    
    <span style='color:#696969;'>; initialize state</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> b2s_iv
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#696969;'>; eax ^= outlen</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>
    <span style='color:#696969;'>; keylen &lt;&lt; 8</span>
    <span style='color:#800000;font-weight:bold;'>shl</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#696969;'>; eax ^= keylen</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    <span style='color:#696969;'>; eax ^= 0x01010000</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>001010000h</span>
    <span style='color:#696969;'>; c-&gt;s.w[0] = eax</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>7</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsd</span>
    
    <span style='color:#696969;'>; edi now points to ctx-&gt;buffer</span>
    <span style='color:#696969;'>; zero initialize</span>
    <span style='color:#696969;'>; also c-&gt;len.q = 0</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>19</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>stosd</span>
    
    <span style='color:#696969;'>; edi now points to index</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+16</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; keylen</span>
    <span style='color:#800000;font-weight:bold;'>jecxz</span>  <span style='color:#e34adc;'>b2_kl</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#800000;font-weight:bold;'>byte</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>64</span>
<span style='color:#e34adc;'>b2_kl:</span>
    <span style='color:#696969;'>; c-&gt;outlen = outlen</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>    
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+12</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; key</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>

    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<strong>Compression Function F</strong>

<strong>Message Schedule SIGMA</strong>

Message word schedule permutations for each round of both BLAKE2b and BLAKE2s are defined by SIGMA. For BLAKE2b, the two extra permutations for rounds 10 and 11 are SIGMA[10..11] = SIGMA[0..1].

The reference code uses a 10x16 array which requires 160 bytes of ROM.

<pre style='color:#000020;background:#f6f8ff;'><span style='color:#200080;font-weight:bold;'>const</span> uint8_t sigma<span style='color:#308080;'>[</span><span style='color:#008c00;'>10</span><span style='color:#308080;'>]</span><span style='color:#308080;'>[</span><span style='color:#008c00;'>16</span><span style='color:#308080;'>]</span> <span style='color:#308080;'>=</span> <span style='color:#406080;'>{</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span> <span style='color:#406080;'>}</span><span style='color:#308080;'>,</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span> <span style='color:#406080;'>}</span><span style='color:#308080;'>,</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span> <span style='color:#406080;'>}</span><span style='color:#308080;'>,</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span> <span style='color:#406080;'>}</span><span style='color:#308080;'>,</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span> <span style='color:#406080;'>}</span><span style='color:#308080;'>,</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>9</span> <span style='color:#406080;'>}</span><span style='color:#308080;'>,</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span> <span style='color:#406080;'>}</span><span style='color:#308080;'>,</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span> <span style='color:#406080;'>}</span><span style='color:#308080;'>,</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span> <span style='color:#406080;'>}</span><span style='color:#308080;'>,</span>
           <span style='color:#406080;'>{</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>0</span> <span style='color:#406080;'>}</span>
</pre>

Because there are only 16 32-bit words in a message block, each byte can be stored as a 4-bit nibble thus only requiring 80 bytes of space.

<pre style='color:#000020;background:#f6f8ff;'>uint64_t sigma64<span style='color:#308080;'>[</span><span style='color:#008c00;'>10</span><span style='color:#308080;'>]</span> <span style='color:#308080;'>=</span> 
<span style='color:#406080;'>{</span> <span style='color:#008000;'>0xfedcba9876543210</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0x357b20c16df984ae</span><span style='color:#308080;'>,</span>
  <span style='color:#008000;'>0x491763eadf250c8b</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0x8f04a562ebcd1397</span><span style='color:#308080;'>,</span>
  <span style='color:#008000;'>0xd386cb1efa427509</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0x91ef57d438b0a6c2</span><span style='color:#308080;'>,</span>
  <span style='color:#008000;'>0xb8293670a4def15c</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0xa2684f05931ce7bd</span><span style='color:#308080;'>,</span>
  <span style='color:#008000;'>0x5a417d2c803b9ef6</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0x0dc3e9bf5167482a</span> <span style='color:#406080;'>}</span><span style='color:#406080;'>;</span>
</pre>

<strong>G Mixing Function</strong>

The reference implementation uses a macro B2S_G which is almost identical to the Quarter-Round macro in ChaCha stream cipher. The main difference is the bit-rotations are right instead of left and there are 2 additions of the message block using the SIGMA permutations as indexes.

<pre style='color:#000020;background:#f6f8ff;'><span style='color:#200080;font-weight:bold;'>for</span> <span style='color:#308080;'>(</span>i <span style='color:#308080;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#406080;'>;</span> i <span style='color:#308080;'>&lt;</span> <span style='color:#008c00;'>10</span><span style='color:#406080;'>;</span> i<span style='color:#308080;'>+</span><span style='color:#308080;'>+</span><span style='color:#308080;'>)</span> <span style='color:#406080;'>{</span>          <span style='color:#595979;'>// ten rounds</span>
           B2S_G<span style='color:#308080;'>(</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span>  <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>)</span><span style='color:#406080;'>;</span>
           B2S_G<span style='color:#308080;'>(</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span>  <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>)</span><span style='color:#406080;'>;</span>
           B2S_G<span style='color:#308080;'>(</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>)</span><span style='color:#406080;'>;</span>
           B2S_G<span style='color:#308080;'>(</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>)</span><span style='color:#406080;'>;</span>
           B2S_G<span style='color:#308080;'>(</span> <span style='color:#008c00;'>0</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>5</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>15</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>8</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span> <span style='color:#008c00;'>9</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>)</span><span style='color:#406080;'>;</span>
           B2S_G<span style='color:#308080;'>(</span> <span style='color:#008c00;'>1</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>11</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>12</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span><span style='color:#008c00;'>10</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span><span style='color:#008c00;'>11</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>)</span><span style='color:#406080;'>;</span>
           B2S_G<span style='color:#308080;'>(</span> <span style='color:#008c00;'>2</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#308080;'>,</span>  <span style='color:#008c00;'>8</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span><span style='color:#008c00;'>12</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span><span style='color:#008c00;'>13</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>)</span><span style='color:#406080;'>;</span>
           B2S_G<span style='color:#308080;'>(</span> <span style='color:#008c00;'>3</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#308080;'>,</span>  <span style='color:#008c00;'>9</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>14</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span><span style='color:#008c00;'>14</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> m<span style='color:#308080;'>[</span>sigma<span style='color:#308080;'>[</span>i<span style='color:#308080;'>]</span><span style='color:#308080;'>[</span><span style='color:#008c00;'>15</span><span style='color:#308080;'>]</span><span style='color:#308080;'>]</span><span style='color:#308080;'>)</span><span style='color:#406080;'>;</span>
       <span style='color:#406080;'>}</span>
</pre>

To reduce the amount of code, B2_SG is converted to a function. It's called 8 times with 4 different work vector indices. Like the sigma permutations, each vector index is stored as a 4-bit nibble thus only requiring 16 instead of 32 bytes.

<pre style='color:#000020;background:#f6f8ff;'>uint16_t idx16<span style='color:#308080;'>[</span><span style='color:#008c00;'>8</span><span style='color:#308080;'>]</span><span style='color:#308080;'>=</span>
<span style='color:#406080;'>{</span> <span style='color:#008000;'>0xC840</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0xD951</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0xEA62</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0xFB73</span><span style='color:#308080;'>,</span> 
  <span style='color:#008000;'>0xFA50</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0xCB61</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0xD872</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>0xE943</span> <span style='color:#406080;'>}</span><span style='color:#406080;'>;</span>
</pre>

index represents 1 of the 16-bit values from above array.

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// G mixing function</span>
<span style='color:#800000;font-weight:bold;'>void</span> G<span style='color:#808030;'>(</span>uint32_t <span style='color:#808030;'>*</span>s<span style='color:#808030;'>,</span> uint32_t <span style='color:#808030;'>*</span>m<span style='color:#808030;'>,</span> uint64_t sigma<span style='color:#808030;'>)</span> 
<span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>int</span>      i<span style='color:#808030;'>,</span> j<span style='color:#800080;'>;</span>
    uint32_t a<span style='color:#808030;'>,</span> b<span style='color:#808030;'>,</span> c<span style='color:#808030;'>,</span> d<span style='color:#808030;'>,</span> r<span style='color:#808030;'>,</span> t<span style='color:#808030;'>,</span> idx<span style='color:#800080;'>;</span>
    
    uint16_t idx16<span style='color:#808030;'>[</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>
    <span style='color:#800080;'>{</span> <span style='color:#008000;'>0xC840</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD951</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xEA62</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xFB73</span><span style='color:#808030;'>,</span>    <span style='color:#696969;'>// column index</span>
      <span style='color:#008000;'>0xFA50</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xCB61</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD872</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xE943</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>  <span style='color:#696969;'>// diagonal index</span>
    
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      idx <span style='color:#808030;'>=</span> idx16<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
        
      a <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>idx         <span style='color:#808030;'>&amp;</span> <span style='color:#008000;'>0xF</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      b <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>idx <span style='color:#808030;'>&gt;</span><span style='color:#808030;'>&gt;</span>  <span style='color:#008c00;'>4</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>&amp;</span> <span style='color:#008000;'>0xF</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      c <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>idx <span style='color:#808030;'>&gt;</span><span style='color:#808030;'>&gt;</span>  <span style='color:#008c00;'>8</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>&amp;</span> <span style='color:#008000;'>0xF</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      d <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>idx <span style='color:#808030;'>&gt;</span><span style='color:#808030;'>&gt;</span> <span style='color:#008c00;'>12</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>&amp;</span> <span style='color:#008000;'>0xF</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
  
      r <span style='color:#808030;'>=</span> <span style='color:#008000;'>0x07080C10</span><span style='color:#800080;'>;</span>
      
      <span style='color:#696969;'>// The quarter-round</span>
      <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>j<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>4</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
        <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>j <span style='color:#808030;'>&amp;</span> <span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span><span style='color:#808030;'>=</span><span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
          s<span style='color:#808030;'>[</span>a<span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> m<span style='color:#808030;'>[</span>sigma <span style='color:#808030;'>&amp;</span> <span style='color:#008000;'>0x0F</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
          sigma <span style='color:#808030;'>&gt;</span><span style='color:#808030;'>&gt;</span><span style='color:#808030;'>=</span> <span style='color:#008c00;'>4</span><span style='color:#800080;'>;</span>
        <span style='color:#800080;'>}</span>
        s<span style='color:#808030;'>[</span>a<span style='color:#808030;'>]</span><span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> s<span style='color:#808030;'>[</span>b<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> 
        s<span style='color:#808030;'>[</span>d<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> ROTR32<span style='color:#808030;'>(</span>s<span style='color:#808030;'>[</span>d<span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span> s<span style='color:#808030;'>[</span>a<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> r <span style='color:#808030;'>&amp;</span> <span style='color:#008000;'>0xFF</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
        XCHG<span style='color:#808030;'>(</span>c<span style='color:#808030;'>,</span> a<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
        XCHG<span style='color:#808030;'>(</span>d<span style='color:#808030;'>,</span> b<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
        r <span style='color:#808030;'>&gt;</span><span style='color:#808030;'>&gt;</span><span style='color:#808030;'>=</span> <span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span> 
      <span style='color:#800080;'>}</span>     
    <span style='color:#800080;'>}</span>       
<span style='color:#800080;'>}</span>
</pre>

The assembly version only requires 1 ROR, 1 ADD and 1 XOR instead of 4 each. This is possible because the first update of a and d is exactly the same as 2nd,3rd and 4th statements with only values swapped around.. The rotation constants are also loaded into ecx which are swapped during a loop.

The trick in looping twice is acheived with JNP/JPO (Jump if no parity/ Jump if parity odd). ebx is set to 1, when it reaches 3, the loop ends. When ecx reaches zero, the main mixing loop ends.

<pre style='color:#000000;background:#fffFff;'><span style='color:#004a43;'>%define</span><span style='color:#004a43;'> a  eax</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> b  edx</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> c  esi</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> d  edi</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> x  edi</span>
<span style='color:#004a43;'>%define</span><span style='color:#004a43;'> t0 ebp</span>

<span style='color:#595979;'>; void b2s_g(blake2_blk *blk, uint16_t index, </span>
<span style='color:#595979;'>;    uint32_t x0, uint32_t x1)</span>
<span style='color:#e34adc;'>b2s_g:</span>
    <span style='color:#200080;font-weight:bold;'>pushad</span>
    <span style='color:#200080;font-weight:bold;'>push</span>   a
    <span style='color:#200080;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>ah</span><span style='color:#308080;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#200080;font-weight:bold;'>aam</span>    <span style='color:#008c00;'>16</span>
    
    <span style='color:#200080;font-weight:bold;'>movzx</span>  <span style='color:#000080;'>ebp</span><span style='color:#308080;'>,</span> <span style='color:#000080;'>ah</span>
    <span style='color:#200080;font-weight:bold;'>movzx</span>  <span style='color:#004a43;'>c</span><span style='color:#308080;'>,</span> <span style='color:#000080;'>al</span>

    <span style='color:#200080;font-weight:bold;'>pop</span>    a
    <span style='color:#200080;font-weight:bold;'>aam</span>    <span style='color:#008c00;'>16</span>
    
    <span style='color:#200080;font-weight:bold;'>movzx</span>  b<span style='color:#308080;'>,</span> <span style='color:#000080;'>ah</span>
    <span style='color:#200080;font-weight:bold;'>movzx</span>  a<span style='color:#308080;'>,</span> <span style='color:#000080;'>al</span>
    
    <span style='color:#200080;font-weight:bold;'>lea</span>    a<span style='color:#308080;'>,</span> <span style='color:#308080;'>[</span>x<span style='color:#308080;'>+</span>a<span style='color:#308080;'>*</span><span style='color:#008c00;'>4</span><span style='color:#308080;'>]</span>
    <span style='color:#200080;font-weight:bold;'>lea</span>    b<span style='color:#308080;'>,</span> <span style='color:#308080;'>[</span>x<span style='color:#308080;'>+</span>b<span style='color:#308080;'>*</span><span style='color:#008c00;'>4</span><span style='color:#308080;'>]</span>
    <span style='color:#200080;font-weight:bold;'>lea</span>    <span style='color:#004a43;'>c</span><span style='color:#308080;'>,</span> <span style='color:#308080;'>[</span>x<span style='color:#308080;'>+</span><span style='color:#004a43;'>c</span><span style='color:#308080;'>*</span><span style='color:#008c00;'>4</span><span style='color:#308080;'>]</span>
    <span style='color:#200080;font-weight:bold;'>lea</span>    d<span style='color:#308080;'>,</span> <span style='color:#308080;'>[</span>x<span style='color:#308080;'>+</span><span style='color:#000080;'>ebp</span><span style='color:#308080;'>*</span><span style='color:#008c00;'>4</span><span style='color:#308080;'>]</span>
    <span style='color:#595979;'>; load ecx with rotate values</span>
    <span style='color:#595979;'>; 16, 12, 8, 7</span>
    <span style='color:#200080;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ecx</span><span style='color:#308080;'>,</span> <span style='color:#008000;'>07080C10h</span>
    <span style='color:#595979;'>; x[a] = PLUS(x[a],x[b]) + x0; </span>
    <span style='color:#200080;font-weight:bold;'>mov</span>    t0<span style='color:#308080;'>,</span> <span style='color:#308080;'>[</span><span style='color:#000080;'>esp</span><span style='color:#308080;'>+</span>_ebx<span style='color:#308080;'>]</span>    <span style='color:#595979;'>; x0</span>
    <span style='color:#200080;font-weight:bold;'>add</span>    t0<span style='color:#308080;'>,</span> <span style='color:#308080;'>[</span>b<span style='color:#308080;'>]</span>
<span style='color:#e34adc;'>q_l1:</span>
    <span style='color:#200080;font-weight:bold;'>mov</span>    <span style='color:#000080;'>bl</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>1</span>
<span style='color:#e34adc;'>q_l2:</span>
    <span style='color:#595979;'>; also x[c] = PLUS(x[c],x[d]);</span>
    <span style='color:#200080;font-weight:bold;'>add</span>    t0<span style='color:#308080;'>,</span> <span style='color:#308080;'>[</span>a<span style='color:#308080;'>]</span>
    <span style='color:#200080;font-weight:bold;'>mov</span>    <span style='color:#308080;'>[</span>a<span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> t0
    <span style='color:#595979;'>; x[d] = ROTATE(XOR(x[d],x[a]),cl);</span>
    <span style='color:#595979;'>; also x[b] = ROTATE(XOR(x[b],x[c]),cl);</span>
    <span style='color:#200080;font-weight:bold;'>xor</span>    t0<span style='color:#308080;'>,</span> <span style='color:#308080;'>[</span>d<span style='color:#308080;'>]</span>
    <span style='color:#200080;font-weight:bold;'>ror</span>    t0<span style='color:#308080;'>,</span> <span style='color:#000080;'>cl</span>
    <span style='color:#200080;font-weight:bold;'>mov</span>    <span style='color:#308080;'>[</span>d<span style='color:#308080;'>]</span><span style='color:#308080;'>,</span> t0
    <span style='color:#200080;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>cl</span><span style='color:#308080;'>,</span> <span style='color:#000080;'>ch</span>
    <span style='color:#200080;font-weight:bold;'>xchg</span>   <span style='color:#004a43;'>c</span><span style='color:#308080;'>,</span> a
    <span style='color:#200080;font-weight:bold;'>xchg</span>   d<span style='color:#308080;'>,</span> b
    <span style='color:#200080;font-weight:bold;'>inc</span>    <span style='color:#000080;'>ebx</span>
    <span style='color:#200080;font-weight:bold;'>jpo</span>    <span style='color:#e34adc;'>q_l2</span>
    <span style='color:#595979;'>; x[a] = PLUS(x[a],x[b]) + x1; </span>
    <span style='color:#200080;font-weight:bold;'>add</span>    t0<span style='color:#308080;'>,</span> <span style='color:#308080;'>[</span><span style='color:#000080;'>esp</span><span style='color:#308080;'>+</span>_ecx<span style='color:#308080;'>]</span>     <span style='color:#595979;'>; x1</span>
    <span style='color:#595979;'>; --------------------------------------------</span>
    <span style='color:#200080;font-weight:bold;'>shr</span>    <span style='color:#000080;'>ecx</span><span style='color:#308080;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#200080;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>q_l1</span>

    <span style='color:#200080;font-weight:bold;'>popad</span>
    <span style='color:#200080;font-weight:bold;'>ret</span>
</pre>

The compression function

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// F compression function</span>
<span style='color:#800000;font-weight:bold;'>void</span> F<span style='color:#808030;'>(</span>b2s_ctx <span style='color:#808030;'>*</span>c<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>int</span> last<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    uint32_t  i<span style='color:#808030;'>,</span> j<span style='color:#808030;'>,</span> x0<span style='color:#808030;'>,</span> x1<span style='color:#800080;'>;</span>
    w512_t v<span style='color:#808030;'>,</span> m<span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// initialization vectors</span>
    uint32_t b2s_iv<span style='color:#808030;'>[</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span>
    <span style='color:#800080;'>{</span> <span style='color:#008000;'>0x6A09E667</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xBB67AE85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3C6EF372</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA54FF53A</span><span style='color:#808030;'>,</span>
      <span style='color:#008000;'>0x510E527F</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9B05688C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1F83D9AB</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5BE0CD19</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>
      
    <span style='color:#696969;'>// permutations</span>
    uint64_t sigma64<span style='color:#808030;'>[</span><span style='color:#008c00;'>10</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> 
    <span style='color:#800080;'>{</span> <span style='color:#008000;'>0xfedcba9876543210</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x357b20c16df984ae</span><span style='color:#808030;'>,</span>
      <span style='color:#008000;'>0x491763eadf250c8b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8f04a562ebcd1397</span><span style='color:#808030;'>,</span>
      <span style='color:#008000;'>0xd386cb1efa427509</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x91ef57d438b0a6c2</span><span style='color:#808030;'>,</span>
      <span style='color:#008000;'>0xb8293670a4def15c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa2684f05931ce7bd</span><span style='color:#808030;'>,</span>
      <span style='color:#008000;'>0x5a417d2c803b9ef6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0dc3e9bf5167482a</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// initialize v work vector with iv and s</span>
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span>BLAKE2s_LBLOCK<span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      v<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span>i    <span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>s<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
      v<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span>i <span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> b2s_iv<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    
    <span style='color:#696969;'>// copy message x into m</span>
    <span style='color:#603000;'>memcpy</span><span style='color:#808030;'>(</span>m<span style='color:#808030;'>.</span>b<span style='color:#808030;'>,</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>,</span> <span style='color:#008c00;'>64</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// xor v with current length</span>
    v<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>12</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>len<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    v<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>13</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>len<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// if this is last block, invert word 14</span>
    v<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>14</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>-</span>last<span style='color:#800080;'>;</span>
    
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>10</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      G<span style='color:#808030;'>(</span>v<span style='color:#808030;'>.</span>w<span style='color:#808030;'>,</span> m<span style='color:#808030;'>.</span>w<span style='color:#808030;'>,</span> sigma64<span style='color:#808030;'>[</span>i<span style='color:#808030;'>%</span><span style='color:#008c00;'>10</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    <span style='color:#696969;'>// update s with v</span>
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span>BLAKE2s_LBLOCK<span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>s<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> v<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span> v<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span>i <span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>


Initialization of v work vector with state and b2s_iv is done using CMC (Complement Carry). On the first loop, the flag CF is clear and context state is loaded into v. CMC will set CF to 1 thus repeating the loop except this time loading remainder of v with the initialization vector. 

The inversion of bits at block 14 is acheived by negating edx which should be zero or one. If it is 1, it becomes -1 and inverts the bits using an XOR. If edx is zero, the XOR does nothing. 

The SIGMA indices required for message block are separated using AAM.

<pre style='color:#000000;background:#ffffff;'><span style='color:#e34adc;'>_b2s_compressx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esi</span>
    <span style='color:#696969;'>; create space for v + m</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>124</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>
    <span style='color:#696969;'>; initialize v with state and chaining variables</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>          <span style='color:#696969;'>; edi = v</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> b2s_iv 
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>32</span>                <span style='color:#696969;'>; move 32 bytes</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ecx</span>
<span style='color:#e34adc;'>b2t_l1:</span>                      <span style='color:#696969;'>; first is ctx-&gt;state</span>
                             <span style='color:#696969;'>; then b2s_iv</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>32</span>
    <span style='color:#800000;font-weight:bold;'>cmc</span>                      <span style='color:#696969;'>; complement</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>jc</span>     <span style='color:#e34adc;'>b2t_l1</span>            <span style='color:#696969;'>; continue if carry</span>
    
    <span style='color:#696969;'>; esi should now be ctx-&gt;buffer</span>
    <span style='color:#696969;'>; edi will be m</span>
    <span style='color:#696969;'>; ecx will be 32</span>
    <span style='color:#696969;'>; copy buffer into m</span>
    <span style='color:#696969;'>; save edi in eax</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsw</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>
    
    <span style='color:#696969;'>; esi now points to ctx-&gt;len</span>
    <span style='color:#696969;'>; xor v with current length</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>12</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#008c00;'>-64</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>13</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#008c00;'>-64</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    
    <span style='color:#696969;'>; if this is last block, invert word 14</span>
    <span style='color:#696969;'>; 1 becomes -1, 0 remains 0</span>
    <span style='color:#800000;font-weight:bold;'>neg</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>14</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#008c00;'>-64</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    
    <span style='color:#696969;'>; do minimum of 10 rounds</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>
<span style='color:#e34adc;'>b2t_l2:</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esi</span>
<span style='color:#e34adc;'>b2t_l3:</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>10</span>
    <span style='color:#800000;font-weight:bold;'>je</span>     <span style='color:#e34adc;'>b2t_l2</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebp</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span>b2s_sigma6<span style='color:#008c00;'>4</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>*</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span>b2s_sigma6<span style='color:#008c00;'>4</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>*</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>]</span>
<span style='color:#e34adc;'>b2t_l4:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>aam</span>    <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ah</span>
    <span style='color:#800000;font-weight:bold;'>movzx</span>  <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#000080;'>eax</span><span style='color:#808030;'>]</span>              <span style='color:#696969;'>; m.v32[x0]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#000080;'>ecx</span><span style='color:#808030;'>]</span>              <span style='color:#696969;'>; m.v32[x1]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>dword</span><span style='color:#808030;'>[</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>+</span>b2s_idx1<span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span>   <span style='color:#696969;'>; b2s_idx16[j]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span>_esp<span style='color:#808030;'>-</span><span style='color:#008c00;'>96</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>b2s_g</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>shrd</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>shr</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>ebp</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>b2t_l4</span>
    
    <span style='color:#696969;'>; check rnds</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>esi</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>b2t_l3</span>
    
    <span style='color:#696969;'>; update state with work vector</span>
<span style='color:#e34adc;'>b2t_l5:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>68</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>-68</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>*</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>dec</span>    <span style='color:#000080;'>ebp</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>b2t_l5</span>
    
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>124</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<strong>Updating</strong>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// update context</span>
<span style='color:#800000;font-weight:bold;'>void</span> b2s_update <span style='color:#808030;'>(</span>b2s_ctx <span style='color:#808030;'>*</span>c<span style='color:#808030;'>,</span> 
  <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>input<span style='color:#808030;'>,</span> uint32_t len<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    uint32_t i<span style='color:#800080;'>;</span>
    uint8_t <span style='color:#808030;'>*</span>p<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint8_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>input<span style='color:#800080;'>;</span>
    
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>len<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span> <span style='color:#800000;font-weight:bold;'>return</span><span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// update x and s</span>
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span>len<span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>idx<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span><span style='color:#008c00;'>64</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
        c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>len<span style='color:#808030;'>.</span>q <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>idx<span style='color:#800080;'>;</span>
        F<span style='color:#808030;'>(</span>c<span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
        c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>idx <span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>
      <span style='color:#800080;'>}</span>
      c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>idx<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> p<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>      
    <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

Assembly


<pre style='color:#000000;background:#ffffff;'><span style='color:#e34adc;'>_b2s_updatex:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>           <span style='color:#696969;'>; ctx</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>           <span style='color:#696969;'>; len</span>
    <span style='color:#800000;font-weight:bold;'>jecxz</span>  <span style='color:#e34adc;'>ex_upd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>           <span style='color:#696969;'>; input</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span>index<span style='color:#808030;'>]</span> <span style='color:#696969;'>; index</span>
<span style='color:#e34adc;'>b2_upd:</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>64</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>b2_ab</span>
    <span style='color:#696969;'>; ctx-&gt;len.v64 += index</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#800000;font-weight:bold;'>dword</span><span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span>len<span style='color:#808030;'>+</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>   
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span>              <span style='color:#696969;'>; last=0</span>
    <span style='color:#800000;font-weight:bold;'>adc</span>    <span style='color:#800000;font-weight:bold;'>dword</span><span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span>len<span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>_b2s_compressx</span>
<span style='color:#e34adc;'>b2_ab:</span>
    <span style='color:#800000;font-weight:bold;'>lodsb</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span>buffer<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>b2_upd</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span>index<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
<span style='color:#e34adc;'>ex_upd:</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<strong>Finalizing</strong>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// Finalize</span>
<span style='color:#800000;font-weight:bold;'>void</span> b2s_final <span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>void</span><span style='color:#808030;'>*</span> out<span style='color:#808030;'>,</span> b2s_ctx <span style='color:#808030;'>*</span>c<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    uint32_t i<span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// update length with current idx to x</span>
    c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>len<span style='color:#808030;'>.</span>q <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>idx<span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// zero remainder of x</span>
    <span style='color:#603000;'>memset</span><span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>idx<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>64</span> <span style='color:#808030;'>-</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>idx<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// compress last block</span>
    F<span style='color:#808030;'>(</span>c<span style='color:#808030;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// copy s to output</span>
    <span style='color:#603000;'>memcpy</span><span style='color:#808030;'>(</span>out<span style='color:#808030;'>,</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>s<span style='color:#808030;'>.</span>b<span style='color:#808030;'>,</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>outlen<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>
</pre>

Assembly..

<pre style='color:#000000;background:#ffffff;'><span style='color:#e34adc;'>_b2s_finalx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>    <span style='color:#696969;'>; out</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>]</span>    <span style='color:#696969;'>; ctx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span>index<span style='color:#808030;'>]</span>   <span style='color:#696969;'>; index</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#800000;font-weight:bold;'>dword</span><span style='color:#808030;'>[</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span>len<span style='color:#808030;'>+</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>adc</span>    <span style='color:#800000;font-weight:bold;'>dword</span><span style='color:#808030;'>[</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span>len<span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ecx</span><span style='color:#808030;'>+</span>buffer<span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>neg</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>64</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>stosb</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>                 <span style='color:#696969;'>; last=1</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>_b2s_compressx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span>outlen<span style='color:#808030;'>]</span> <span style='color:#696969;'>; outlen</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<strong>Results</strong>
<table>
<tbody>
<tr>
<th>architecture</th>
<th>size in bytes</th>
</tr>
<tr>
<td>x86</td>
<td>510</td>
</tr>
<tr>
<td>x64</td>
<td>n/a</td>
</tr>
</tbody>
</table>

Future updates to C/assembly may not be shown here. Please refer to sources <a href="https://github.com/odzhan/tinycrypt/tree/master/hash/blake2">here</a> and <a href="https://github.com/peterferrie/blake2">here</a>
